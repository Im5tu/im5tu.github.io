<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Stuart Blackler "><meta name="description" content="A look into how we can use dotnet-counters with a docker container"><meta name="keywords" content=",aspnet,dotnet,diagnostics"><meta name="robots" content="noodp"><meta name="theme-color" content><link rel="canonical" href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/"><title>Diagnostics in .Net Core 3: Using dotnet-counters with Docker :: CodeWithStu's Blog</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://im5tu.io/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css" integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k="><link rel="apple-touch-icon" sizes="180x180" href="https://im5tu.io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://im5tu.io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://im5tu.io/favicon-16x16.png"><link rel="manifest" href="https://im5tu.io/site.webmanifest"><link rel="mask-icon" href="https://im5tu.io/safari-pinned-tab.svg" color><link rel="shortcut icon" href="https://im5tu.io/favicon.ico"><meta name="msapplication-TileColor" content><meta itemprop="name" content="Diagnostics in .Net Core 3: Using dotnet-counters with Docker"><meta itemprop="description" content="A look into how we can use dotnet-counters with a docker container"><meta itemprop="datePublished" content="2020-01-25T13:00:00+00:00"><meta itemprop="dateModified" content="2020-01-25T13:00:00+00:00"><meta itemprop="wordCount" content="885"><meta itemprop="keywords" content="aspnet,dotnet,diagnostics,"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Diagnostics in .Net Core 3: Using dotnet-counters with Docker"><meta name="twitter:description" content="A look into how we can use dotnet-counters with a docker container"><meta property="og:title" content="Diagnostics in .Net Core 3: Using dotnet-counters with Docker"><meta property="og:description" content="A look into how we can use dotnet-counters with a docker container"><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/"><meta property="article:section" content="article"><meta property="article:published_time" content="2020-01-25T13:00:00+00:00"><meta property="article:modified_time" content="2020-01-25T13:00:00+00:00"><meta property="og:see_also" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/"><meta property="og:see_also" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/"><meta property="og:see_also" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/"><meta property="og:see_also" content="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/"><meta property="article:section" content="Development"><meta property="article:published_time" content="2020-01-25 13:00:00 +0000 UTC"><meta property="og:image" content="https://im5tu.io/img/profile.png"><meta property="og:site_name" content="CodeWithStu's Blog"><link rel="alternate" type="application/rss+xml" href="https://im5tu.io/article/index.xml" title="Stuart Blackler's Blog"><link rel="preconnect" href="https://api.github.com"><link rel="preconnect" href="https://partner.googleadservices.com"><link rel="preconnect" href="https://tpc.googlesyndication.com"><link rel="preconnect" href="https://www.googletagservices.com"><link rel="preconnect" href="https://googleads.g.doubleclick.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Bold.woff2"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Regular.woff2"><style>body p{line-height:1.8em}main{padding:4em 0 0}a:hover{color:#004dc9}.post,.posts{max-width:1400px;padding:4em 0 0}.header__inner{width:100%;max-width:1400px}ul.menu__inner{padding-right:0}ul.menu__inner li:last-of-type{margin-right:0}.logo__cursor{background:#3b82f6}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2{margin-top:1.5em}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}#promotions img{margin:20px auto}#sponsorMessage{width:100%;background:#ffdf00;color:#242325;padding:10px;font-size:.9em}.flex-container{width:100%;display:inline-flex;justify-content:space-between}.flex-box{display:block}.hidden{display:hidden}.post-title{font-weight:700}.post-summary{font-style:italic;font-size:.8em;color:#222}.post-tags{font-size:.9em}.post-tags span.tag{margin:0 .5em;color:#111;text-decoration:underline}#introduction{margin:0 auto;text-align:center}#introduction p{display:block;text-align:center}#introduction p:first-child{font-weight:700;font-size:1.4em}#introduction p:nth-child(2){font-size:1.3em;font-style:italic}#introduction-container{width:80%;max-width:1400px;text-align:center}#introduction-whatido{margin-top:2em;background-color:#fafafa;width:100%;padding:3em 0}#introduction-whatido *{text-align:center}#introduction-whatido p{text-align:justify}#introduction-whatido .flex-box{margin:0 2.5em;width:100%}#introduction-whatido .flex-box span.home-link{font-size:1.8em;margin-bottom:2em;color:#0665ff;font-weight:700;text-align:center}#introduction-whatido .flex-box span.home-link a,#introduction-whatido .flex-box span.home-link a:link{text-align:center;text-decoration:none}.footer{padding:0}#scroll-progress{position:absolute;bottom:0;left:0;width:0%;height:4px;background:#0665ff;z-index:10000}.header{position:fixed;top:0;width:100%;z-index:10000}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}.post-summary,.post-tags span.tag{color:#eaeaea}}@media(max-width:1450px){.post,.posts,main{padding:4em}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QLMVXHCJ5K"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QLMVXHCJ5K")</script><script data-ad-client="ca-pub-8597760177900459" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div class="container"><header class="header"><span class="header__inner"><a href="https://im5tu.io/" style="text-decoration:none"><div class="logo"><span class="logo__mark">></span>
<span class="logo__text">CodeWithStu</span>
<span class="logo__cursor"></span></div></a><span class="header__right"><nav class="menu"><ul class="menu__inner"><li><a href="https://im5tu.io/article/">Blog</a></li><li><a href="https://news.codewithstu.tv">Newsletter</a></li><li><a href="https://www.patreon.com/CodeWithStu">Patreon</a></li><li><a href="https://twitter.com/CodeWithStu">Twitter</a></li><li><a href="https://codewithstu.tv">YouTube</a></li></ul></nav><span class="menu-trigger"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span><div id="scroll-progress"></div></header><div class="content"><main class="post"><div style="font-style:italic;width:100%;background-color:#ffe12b;color:#333;text-align:center;padding:1px"><p>This page is available to sponsor. <a id="sponsorLink" href="https://im5tu.io/sponsorship/" ref="nofollow" target="_blank">Click Here</a> for more details!</p></div><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class="post-title"><a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/">Diagnostics in .Net Core 3: Using dotnet-counters with Docker</a></h1><hr><aside id="toc"><div class="toc-title">Table of Contents</div><nav id="TableOfContents"><ul><li><a href="#creating-our-diagnostics-image">Creating our diagnostics image</a><ul><li><a href="#setting-up-the-host-image">Setting up the host image</a></li></ul></li><li><a href="#connecting-from-the-diagnostics-image-to-the-host-image">Connecting from the diagnostics image to the host image</a></li><li><a href="#recap">Recap</a></li></ul></nav></aside><hr><div class="post-content"><div style="font-style:italic;width:100%;background-color:#63e5ff;color:#333;text-align:center;padding:5px"><p>This post is part of the <a href="#series" style="font-weight:700">Diagnostics in .Net Core 3</a> series.</p></div><p>In my <a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/">previous post</a>, I described how we can leverage the new EventCounter diagnostics API to add custom event counters and listen for built in counters. In this article, I will walk through how we can leverage the <code>dotnet-counters</code> tool with a running docker image.</p><h2 id="creating-our-diagnostics-image">Creating our diagnostics image</h2><p>In order to connect to a docker image, we will create a diagnostics image which will host the same .Net SDK version as our application and will have the <code>dotnet-counters</code> tool pre-installed:</p><pre><code class="language-dockerfile">FROM mcr.microsoft.com/dotnet/core/sdk:3.1
RUN mkdir /root/.dotnet/tools
ENV PATH=&quot;/root/.dotnet/tools:${PATH}&quot;
RUN  dotnet tool install dotnet-counters --global
WORKDIR /diagnostics
ENTRYPOINT [ &quot;/bin/bash&quot; ]
</code></pre><p>A common mistake when creating docker images that contain .Net tools which are installed globally is not remembering to add the tool path, in this case <code>/root/.dotnet/tools/</code> to the PATH so that it can be globally executed. Luckily, the .Net CLI will remind you in the build logs should you forget to do this.</p><p>Note: <em>You can see the other tools that are available <a href="https://github.com/dotnet/diagnostics/tree/master/src/Tools">here</a>.</em></p><p>Now that we have our docker image ready, we can build with the following command:</p><pre><code class="language-bash">docker build -f diagnostics.Dockerfile -t dotnetdiag:3.1 .
</code></pre><h3 id="setting-up-the-host-image">Setting up the host image</h3><p>For the purposes of this article, we will setup our application using a brand new application within a dockerfile, created by <code>dotnet new</code>:</p><pre><code class="language-dockerfile">FROM mcr.microsoft.com/dotnet/core/sdk:3.1
WORKDIR /app
EXPOSE 5000
EXPOSE 5001
RUN dotnet new webapp -n BlogApp
WORKDIR /app/BlogApp
ENTRYPOINT dotnet run -c Release
</code></pre><p>And we will build our application with the following command line:</p><pre><code class="language-bash">docker build -f app.Dockerfile --name app -t dotnetapp:latest .
</code></pre><p>Once you have you&rsquo;re application built we are ready to start our docker image with debugging enabled.</p><h2 id="connecting-from-the-diagnostics-image-to-the-host-image">Connecting from the diagnostics image to the host image</h2><p>Normally we would start our applications with a command line similar to this:</p><pre><code class="language-bash">docker run --rm --name app dotnetapp:latest
</code></pre><p>However, in order to be able to connect to the running application we need to mount a volume to the temporary directory on the application container. We can do this by appending <code>-v dotnetdiag:/tmp</code>, which instructs docker to mount a named volume <code>dotnetdiag</code> to the path <code>/tmp</code>. Docker will create the named volume during startup if it does not exist.</p><p>We mount the volume because as the .Net runtime starts up, it places a load of temporary files into the <code>/tmp</code> directory such as the following:</p><pre><code>root@379211a5012a:/# ls /tmp
CoreFxPipe_root.b5he0_wwfcD_lH7g471Brpw4X   VBCSCompiler
jiksomfd.ri0                                NuGetScratch
hn2K8eq8bHUcTVSgvuckPlSK9tw9_ORiMDm_Vn4ylfI system-commandline-sentinel-files
</code></pre><p><em>Note the inclusion of the file beginning with <code>CoreFxPipe_root</code>, which is the EventPipe that we will connect to.</em></p><p>Once the application is running, we are now able to start connecting to our application. Normally we would run the following command line to start the diagnostics image: <code>docker run --rm -it --pid=container:app --net=container:app -v dotnetdiag:/tmp --cap-add ALL --privileged dotnetdiag:3.1</code>. Before we execute this command, we need to modify it by add arguments for:</p><ul><li>Mounting to the same volume as the running application</li><li>Be able to inspect the process list of the running application,</li><li>Be able to share the same networking as the running application,</li><li>Elevate execution for the new container</li></ul><p>Without completing the steps listed above we will be unable to connect to the running application. For mounting the volume we can use the exact same argument as before (<code>-v dotnetdiag:/tmp</code>).</p><p>In order to get the process id, we need to join the same process namespace through the use of the <a href="https://docs.docker.com/engine/reference/run/#pid-settings---pid">&ndash;pid</a> argument. The <code>--pid</code> offers two modes, container or host. For this article, we will connect to a specific container by name, though you can also connect to the container by id as well.</p><p>Like the process argument, we also need to join the same networking space as the running container. So we will use <a href="https://docs.docker.com/engine/reference/run/#network-settings">&ndash;net</a> which can also be run in multiple modes. For this article, we will connect to the application via the container name.</p><p>Lastly, by default, Docker containers restrict a lot of what you can do with running processes, like run docker in docker. So we need to tell docker to run in privileged mode and what capabilities we require to have from our diagnostics container. For this we will use the <code>--cap-add</code> and the <code>--privileged</code> arguments. Click <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">here</a> to read more about runtime privilege and docker capabilities.</p><p>After putting it all together, here is the full command line that we will run:</p><pre><code class="language-bash">docker run --rm -it --pid=container:app --net=container:app -v dotnetdiag:/tmp --cap-add ALL --privileged dotnetdiag:3.1
</code></pre><p>Now you should have an empty command line to run, so if we execute <code>dotnet-counters ps</code> you should see something similar to the following:</p><pre><code class="language-bash">root@9663cbb4e1fe:/diagnostics# dotnet-counters ps
       103 BlogApp    /app/BlogApp/bin/Release/netcoreapp3.1/BlogApp
         6 dotnet     /usr/share/dotnet/dotnet
        42 dotnet     /usr/share/dotnet/dotnet
        61 dotnet     /usr/share/dotnet/dotnet
       247 dotnet-counters /root/.dotnet/tools/dotnet-counters
</code></pre><p>Assuming that your application is running under process id <strong>103</strong> then we would execute the following command to view the counters:</p><pre><code class="language-bash">root@9663cbb4e1fe:/diagnostics# dotnet-counters monitor -p 103 System.Runtime Microsoft.AspNetCore.Hosting
</code></pre><h2 id="recap">Recap</h2><p>In order to diagnose a running docker image from another docker image, you need to:</p><ul><li>Mount the <code>/tmp</code> on the application image prior to starting the application</li><li>Create a diagnostic image with your diagnostics tools</li><li>Run your diagnostics image with the following arguments:<ul><li><code>-v</code> for mounting to the same volume as the application image</li><li><code>--pid</code> for joining the same process space</li><li><code>--net</code> for joining the same network</li><li><code>--privileged</code> for requesting additional permissions to cross container boundaries, and</li><li><code>--cap-add ALL</code> for adding the ability to list processes etc.</li></ul></li></ul><p>Happy diagnostics!</p></div></article><hr><div class="post-info"><a name="series"></a>
<b>More in the Diagnostics in .Net Core 3 series:</b><ol><li><a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/">Diagnostics in .Net Core 3: Event Counters</a></li><li><b>Diagnostics in .Net Core 3: Using dotnet-counters with Docker <i>(This article)</i></b></li><li><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/">Diagnostics in .Net Core 3: Listening to outbound HTTP requests</a></li><li><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/">Diagnostics in .Net Core 3: Listening to inbound HTTP requests</a></li><li><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/">Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker</a></li></ol><p><a href="https://im5tu.io/series/diagnostics-in-.net-core-3/">View All Articles</a></p><hr><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class="tag"><a href="https://im5tu.io/tags/aspnet/">aspnet</a></span><span class="tag"><a href="https://im5tu.io/tags/dotnet/">dotnet</a></span><span class="tag"><a href="https://im5tu.io/tags/diagnostics/">diagnostics</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>885 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-01-25</p></div><hr><div id="promotions"><a href="https://geni.us/cws-springer" target="_blank"><img src="https://www.awltovhc.com/image-100677210-15518210" width="728" height="90" alt="Apress eBook Sale is here now! - Order selected eBooks for $12.99 each. (3rd-20th May)"></a>
<a href="https://geni.us/cws-namecheap" target="_blank"><img src="https://www.awltovhc.com/image-100677210-14326263" width="728" height="90" alt="Popular Domains for just 99 Cents at Namecheap!"></a>
<a href="https://geni.us/cws-mailchimp" target="_blank"><img src="https://www.ftjcfx.com/image-100677210-15488213" width="728" height="90" alt="See upto 88% more revenue with predictive segments!"></a></div></main></div><footer class="footer"><hr><div class="footer__inner"><div class="footer__content"><iframe src="https://codewithstu.substack.com/embed" width="480" height="320" frameborder="0" scrolling="no"></iframe></div></div><hr><div><div class="footer__inner"><div class="footer__content"><span>&copy; 2023</span>
<span><a href="https://im5tu.io/">Stuart Blackler</a></span>
<span><a href="https://im5tu.io/article/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div><p><a href="https://im5tu.io/tags">Tags</a> | <a href="https://im5tu.io/categories">Categories</a> | <a href="https://im5tu.io/sitemap.xml">Sitemap</a></p></div><div><p>This site uses Google Analytics for Analytics only, so may contain cookies.</p></div></div></footer></div><script type="text/javascript" src="https://im5tu.io/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js" integrity="sha512-IF1JGBDCj5WqlT+uiE4cJ6vhP9+T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script>
<script src="https://im5tu.io/js/site-004f8284.js" defer></script></body></html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Stuart Blackler "><meta name="description" content="A look into how we can create K6 performance test suite from a Github repository template."><meta name="keywords" content=",K6,git,github"><meta name="robots" content="noodp"><meta name="theme-color" content><link rel="canonical" href="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-k6/"><title>Setting Up A Repository Template In Github For K6 :: CodeWithStu's Blog</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://im5tu.io/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css" integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k="><link rel="apple-touch-icon" sizes="180x180" href="https://im5tu.io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://im5tu.io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://im5tu.io/favicon-16x16.png"><link rel="manifest" href="https://im5tu.io/site.webmanifest"><link rel="mask-icon" href="https://im5tu.io/safari-pinned-tab.svg" color><link rel="shortcut icon" href="https://im5tu.io/favicon.ico"><meta name="msapplication-TileColor" content><meta itemprop="name" content="Setting Up A Repository Template In Github For K6"><meta itemprop="description" content="A look into how we can create K6 performance test suite from a Github repository template."><meta itemprop="datePublished" content="2020-10-11T10:45:00+01:00"><meta itemprop="dateModified" content="2020-10-11T10:45:00+01:00"><meta itemprop="wordCount" content="936"><meta itemprop="keywords" content="K6,git,github,"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Setting Up A Repository Template In Github For K6"><meta name="twitter:description" content="A look into how we can create K6 performance test suite from a Github repository template."><meta property="og:title" content="Setting Up A Repository Template In Github For K6"><meta property="og:description" content="A look into how we can create K6 performance test suite from a Github repository template."><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-k6/"><meta property="article:section" content="article"><meta property="article:published_time" content="2020-10-11T10:45:00+01:00"><meta property="article:modified_time" content="2020-10-11T10:45:00+01:00"><meta property="og:see_also" content="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-.net/"><meta property="article:section" content="Development"><meta property="article:published_time" content="2020-10-11 10:45:00 +0100 +0100"><meta property="og:image" content="https://im5tu.io/img/profile.png"><meta property="og:site_name" content="CodeWithStu's Blog"><link rel="alternate" type="application/rss+xml" href="https://im5tu.io/article/index.xml" title="Stuart Blackler's Blog"><link rel="preconnect" href="https://api.github.com"><link rel="preconnect" href="https://partner.googleadservices.com"><link rel="preconnect" href="https://tpc.googlesyndication.com"><link rel="preconnect" href="https://www.googletagservices.com"><link rel="preconnect" href="https://googleads.g.doubleclick.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Bold.woff2"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Regular.woff2"><style>body p{line-height:1.8em}main{padding:4em 0 0}a:hover{color:#004dc9}.post,.posts{max-width:1400px;padding:4em 0 0}.header__inner{width:100%;max-width:1400px}ul.menu__inner{padding-right:0}ul.menu__inner li:last-of-type{margin-right:0}.logo__cursor{background:#3b82f6}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2{margin-top:1.5em}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}#promotions img{margin:20px auto}#sponsorMessage{width:100%;background:#ffdf00;color:#242325;padding:10px;font-size:.9em}.flex-container{width:100%;display:inline-flex;justify-content:space-between}.flex-box{display:block}.hidden{display:hidden}.post-title{font-weight:700}.post-summary{font-style:italic;font-size:.8em;color:#222}.post-tags{font-size:.9em}.post-tags span.tag{margin:0 .5em;color:#111;text-decoration:underline}#introduction{margin:0 auto;text-align:center}#introduction p{display:block;text-align:center}#introduction p:first-child{font-weight:700;font-size:1.4em}#introduction p:nth-child(2){font-size:1.3em;font-style:italic}#introduction-container{width:80%;max-width:1400px;text-align:center}#introduction-whatido{margin-top:2em;background-color:#fafafa;width:100%;padding:3em 0}#introduction-whatido *{text-align:center}#introduction-whatido p{text-align:justify}#introduction-whatido .flex-box{margin:0 2.5em;width:100%}#introduction-whatido .flex-box span.home-link{font-size:1.8em;margin-bottom:2em;color:#0665ff;font-weight:700;text-align:center}#introduction-whatido .flex-box span.home-link a,#introduction-whatido .flex-box span.home-link a:link{text-align:center;text-decoration:none}.footer{padding:0}#scroll-progress{position:absolute;bottom:0;left:0;width:0%;height:4px;background:#0665ff;z-index:10000}.header{position:fixed;top:0;width:100%;z-index:10000}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}.post-summary,.post-tags span.tag{color:#eaeaea}}@media(max-width:1450px){.post,.posts,main{padding:4em}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QLMVXHCJ5K"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QLMVXHCJ5K")</script><script data-ad-client="ca-pub-8597760177900459" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div class="container"><header class="header"><span class="header__inner"><a href="https://im5tu.io/" style="text-decoration:none"><div class="logo"><span class="logo__mark">></span>
<span class="logo__text">CodeWithStu</span>
<span class="logo__cursor"></span></div></a><span class="header__right"><nav class="menu"><ul class="menu__inner"><li><a href="https://im5tu.io/article/">Blog</a></li><li><a href="https://news.codewithstu.tv">Newsletter</a></li><li><a href="https://www.patreon.com/CodeWithStu">Patreon</a></li><li><a href="https://twitter.com/CodeWithStu">Twitter</a></li><li><a href="https://codewithstu.tv">YouTube</a></li></ul></nav><span class="menu-trigger"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span><div id="scroll-progress"></div></header><div class="content"><main class="post"><div style="font-style:italic;width:100%;background-color:#ffe12b;color:#333;text-align:center;padding:1px"><p>This page is available to sponsor. <a id="sponsorLink" href="https://im5tu.io/sponsorship/" ref="nofollow" target="_blank">Click Here</a> for more details!</p></div><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class="post-title"><a href="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-k6/">Setting Up A Repository Template In Github For K6</a></h1><hr><aside id="toc"><div class="toc-title">Table of Contents</div><nav id="TableOfContents"><ul><li><a href="#folders">Folders</a><ul><li><a href="#lib">lib</a></li><li><a href="#options">options</a></li><li><a href="#services">services</a></li></ul></li><li><a href="#templatejs">TEMPLATE.js</a></li><li><a href="#running-with-docker">Running with Docker</a></li></ul></nav></aside><hr><div class="post-content"><div style="font-style:italic;width:100%;background-color:#63e5ff;color:#333;text-align:center;padding:5px"><p>This post is part of the <a href="#series" style="font-weight:700">Repository Templates</a> series.</p></div><p>In my <a href="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-.net/">previous article</a>, we took a look at setting up a template repository for our .Net projects. Repository templates can massively help with the consistency and startup speed of a new project. In this article, we will take a look at a different repository template that I&rsquo;ve been using for work for running our performance tests.</p><p>For our performance tests, I generally use <a href="https://k6.io">K6</a> which if you&rsquo;re unfamiliar with it, is a simple and easy to use Javascript library for writing simple performance tests such as load tests, spike tests and soak tests. To give you an idea of what you can do with this, I&rsquo;ve used this setup to automate load tests in an Octopus Deploy pipeline by running an ECS task post-deployment. You could also trigger nightly performance tests and have the results posted to Slack if you wanted as well.</p><p>Here is an overview of what the <a href="https://github.com/Im5tu/template-k6">repository template</a> looks like at the time of writing:</p><p><img src="https://im5tu.io/img/template-k6/overview.png" alt="Overview"></p><h2 id="folders">Folders</h2><p>The template contains a number of different folders for different purposes:</p><ul><li><code>lib</code>: javascript extensions that are common to all scripts that are run</li><li><code>options</code>: contains the k6 options such as duration, target virtual users etc</li><li><code>services</code>: contains the urls and other service specific settings</li></ul><p>Logically splitting out the options and services allows us to run the same set of tests against different url&rsquo;s (service settings) and different styles of performance tests (option settings).</p><h3 id="lib">lib</h3><p>In the template, I have a single <code>k6_extensions.js</code> file, though you could easily split out the file into multiple if it grows significantly or depending on your needs. The core functionality this file provides is:</p><ul><li><code>parseResponse</code> - a simple function that checks for a 200/201/202/204 response code. If the check fails, a message is logged to console and the error rate counter incremented.</li><li><code>errorRate</code> - this is a counter that&rsquo;s incremented by the <code>parseResponse</code> function, used as a threshold in the options settings (detailed below)</li><li><code>loadOptions</code> - a helper for loading a file from the <code>options</code> directory</li><li><code>loadServiceConfig</code> - a helper for loading a file from the <code>services</code> directory and adding the execution environment from the command line</li><li><code>withHeaders</code> - sets up the header collection ready for use in the scripts</li><li><code>merge</code> - simple JS object merge utility function</li></ul><p>To use the functions, we add <code>import { &lt;comma separated function names> } from "./lib/k6_extensions.js";</code> to the top of our load test file, replacing <code>&lt;comma separated function names></code> with <code>loadOptions, parseResponse, loadServiceConfig, withHeaders</code> for example.</p><h3 id="options">options</h3><p>Each file under the <code>options</code> folder is designed to control the execution of the K6 runtime. For example, for a soak test, you might want to restrict the maximum requests per second to save on costs. It can also be used to set the thresholds for success/failure and other K6 options.</p><p>Here is an example of a soak test that runs for 4 hours in total:</p><pre><code class="language-json">{
    &quot;stages&quot;: [
        { &quot;target&quot;: 400, &quot;duration&quot;: &quot;2m&quot; },
        { &quot;target&quot;: 400, &quot;duration&quot;: &quot;3h56m&quot; },
        { &quot;target&quot;: 0, &quot;duration&quot;: &quot;2m&quot; }
    ],
    &quot;thresholds&quot;: {
        &quot;errors&quot;: [&quot;rate=0&quot;],
        &quot;http_req_duration&quot;: [&quot;p(95) &lt; 750&quot;],
        &quot;http_reqs&quot;: [&quot;rate&gt;=500&quot;]
    },
    &quot;rps&quot;: 2000,
    &quot;batchPerHost&quot;: 0
}
</code></pre><h3 id="services">services</h3><p>A service file indicates the base url for a given service. It can be extended with other information if you wanted, such as a client id specific to that environment. The environment is selected by the <code>K6_HOSTENV</code> environment variable that is supplied to the command line execution. The format of the files are:</p><pre><code>- environment 1
  - baseUrl
  - Setting 1 for environment 1 (optional)
  - Setting 2 for environment 1 (optional)
- environment 2
  - baseUrl
  - Setting 1 for environment 2 (optional)
  - Setting 2 for environment 2 (optional)
</code></pre><p>Here is an example of a service config:</p><pre><code class="language-json">{
    &quot;local&quot;: {
        &quot;baseUrl&quot;: &quot;https://localhost:5001&quot;
    },
    &quot;qa&quot;: {
        &quot;baseUrl&quot;: &quot;https://test-api.k6.io&quot;
    }
}
</code></pre><h2 id="templatejs">TEMPLATE.js</h2><p>The <code>TEMPLATE.js</code> file is your quick start for writing the tests, simply copy and paste this and being writing the tests. There are a few todo&rsquo;s for you to complete in the file, including:</p><ul><li>Setting the options file to use</li><li>Setting the service file to use</li><li>Updating the tests to point to the correct url&rsquo;s by appending to the base url</li></ul><p>Each web request that is run calls the <code>parseResponse</code> function I mentioned earlier to automatically parse the result of the web call and increment the error counter if appropriate. The template file in the repository will run against the K6 test website, with a successful and unsuccessful call so that you can see what happens in both scenarios.</p><h2 id="running-with-docker">Running with Docker</h2><p>To run the tests with docker, we need to run the following commands (which is encapsulated by the <code>run.ps1</code> file in the template):</p><pre><code class="language-bash">docker build -t test .
docker run -it -e K6_HOSTENV=qa -e K6_SCRIPT=TEMPLATE.js test
</code></pre><p>This copies all of the files into the docker image, so you can use the same image with different execution values at runtime. We set two environment variables that control the execution:</p><ul><li><code>K6_HOSTENV</code> - this selects the right section from the <code>service</code> config file from the loaded script.</li><li><code>K6_SCRIPT</code> - this tells K6 which script to run when the container is started.</li></ul><p>Please note that the environment variables are case sensitive. By using K6&rsquo;s check & threshold functionality in the template, if there is a failed request, the K6 process will exit with a non-zero exit code, which is also returned out through the container as well. This can be very useful in scripted scenarios.</p><p>Now that you&rsquo;ve got an overview of how the repository is setup, you can copy it and make it your own. It would be great to see what you do with your repositories!</p><p>Happy performance testing!</p></div></article><hr><div style="font-size:.8em" itemscope itemtype="https://schema.org/Person"><h2 itemprop="name">About Stuart Blackler</h2><p><strong>Stuart Blackler</strong> is a seasoned technologist with over <span itemprop="experienceInPlaceOfEducation">15 years of commercial experience in the .NET ecosystem</span>. Holding a degree in <span itemprop="alumniOf">Computer Science</span>, Stuart has previously earned certifications as a C# developer through Microsoft and as an AWS Solutions Architect and Developer. Stuart is the creator of the popular YouTube channel <a href="https://youtube.com/@codewithstu" itemprop="url">CodeWithStu</a>, where he delves into topics close to his heart, including .NET, AWS, DevOps, and software architecture with a commitment to sharing knowledge and fostering a community of learners.</p></div><hr><div class="post-info"><a name="series"></a>
<b>More in the Repository Templates series:</b><ol><li><a href="https://im5tu.io/article/2020/10/setting-up-a-repository-template-in-github-for-.net/">Setting Up A Repository Template In Github For .Net</a></li><li><b>Setting Up A Repository Template In Github For K6 <i>(This article)</i></b></li></ol><p><a href="https://im5tu.io/series/repository-templates/">View All Articles</a></p><hr><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class="tag"><a href="https://im5tu.io/tags/k6/">K6</a></span><span class="tag"><a href="https://im5tu.io/tags/git/">git</a></span><span class="tag"><a href="https://im5tu.io/tags/github/">github</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>936 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-10-11</p></div><hr><script src="https://utteranc.es/client.js" repo="Im5tu/im5tu.github.io" issue-term="url" label="Comment" theme="photon-dark" crossorigin="anonymous" async></script></main></div><footer class="footer"><hr><div><div class="footer__inner"><div class="footer__content"><span>&copy; 2023</span>
<span><a href="https://im5tu.io/">Stuart Blackler</a></span>
<span><a href="https://im5tu.io/article/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div><p><a href="https://im5tu.io/tags">Tags</a> | <a href="https://im5tu.io/categories">Categories</a> | <a href="https://im5tu.io/sitemap.xml">Sitemap</a></p></div><div><p>This site uses Google Analytics for Analytics only, so may contain cookies.</p></div></div></footer></div><script type="text/javascript" src="https://im5tu.io/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js" integrity="sha512-IF1JGBDCj5WqlT+uiE4cJ6vhP9+T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script>
<script src="https://im5tu.io/js/site-004f8284.js" defer></script></body></html>
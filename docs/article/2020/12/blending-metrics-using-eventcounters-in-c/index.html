<!doctype html><html lang="en"><head><title>Blending Metrics Using EventCounters In C# | December | 2020 | Articles | CodeWithStu's Blog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Some services like AWS CloudWatch Metrics only allow scaling based off a single value. Luckily, we can blend metrics together to create new ones, which we can then use in our scaling policies"><meta name="keywords" content><link rel="icon" type="image/x-icon" href="https://im5tu.io/assets/favicon.ico"><link rel="canonical" href="https://im5tu.io/article/2020/12/blending-metrics-using-eventcounters-in-c/"><meta property="og:url" content="https://im5tu.io/article/2020/12/blending-metrics-using-eventcounters-in-c/"><meta property="og:type" content="website"><meta property="og:title" content="Blending Metrics Using EventCounters In C# | December | 2020 | Articles | CodeWithStu's Blog"><meta property="og:description" content="Some services like AWS CloudWatch Metrics only allow scaling based off a single value. Luckily, we can blend metrics together to create new ones, which we can then use in our scaling policies"><meta property="og:image" content="/assets/profile.jpg"><meta name="twitter:card" content="summary_large_image"><meta property="twitter:domain" content="im5tu.io"><meta property="twitter:url" content="https://im5tu.io/article/2020/12/blending-metrics-using-eventcounters-in-c/"><meta name="twitter:title" content="Blending Metrics Using EventCounters In C# | December | 2020 | Articles | CodeWithStu's Blog"><meta name="twitter:description" content="Some services like AWS CloudWatch Metrics only allow scaling based off a single value. Luckily, we can blend metrics together to create new ones, which we can then use in our scaling policies"><meta name="twitter:image" content="/assets/profile.jpg"><script defer data-domain="im5tu.io" src="https://plausible.io/js/script.js"></script><style type="text/css">*,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html,:host{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol,noto color emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,liberation mono,courier new,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button,[role=button]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}table{width:100%;table-layout:auto;border-collapse:collapse;text-align:left;font-size:.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity))}table:where([dir=rtl],[dir=rtl] *){text-align:right}@media(prefers-color-scheme:dark){table{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}}table th{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity));font-size:.75rem;line-height:1rem;text-transform:uppercase;--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}@media(prefers-color-scheme:dark){table th{--tw-bg-opacity:1;background-color:rgb(55 65 81/var(--tw-bg-opacity));--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}}table tbody tr{border-bottom-width:1px;--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity));vertical-align:top}@media(prefers-color-scheme:dark){table tbody tr{--tw-border-opacity:1;border-color:rgb(55 65 81/var(--tw-border-opacity));--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity))}}table td,table th{padding-left:1.5rem;padding-right:1.5rem;padding-top:1rem;padding-bottom:1rem;vertical-align:top}table tbody tr:first-child-of-type(td){white-space:nowrap;font-weight:500;--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity))}@media(prefers-color-scheme:dark){table tbody tr:first-child-of-type(td){--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}}h1,h2,h3,h4,h5,h6{line-height:1;letter-spacing:-.025em;--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity))}h1,h2,h3{font-weight:800}h1{margin-top:2rem;margin-bottom:2rem;font-size:2.25rem;line-height:2.5rem}@media(min-width:768px){h1{font-size:3rem;line-height:1}}@media(min-width:1024px){h1{font-size:3.75rem;line-height:1}}h2{margin-top:1.5rem;margin-bottom:1.5rem;font-size:1.875rem;line-height:2.25rem}h3{margin-top:1rem;margin-bottom:1rem;font-size:1.5rem;line-height:2rem}h4,h5,h6{margin-top:.75rem;margin-bottom:.75rem;font-weight:700}h4{font-size:1.25rem;line-height:1.75rem}p{padding-top:1rem;padding-bottom:1rem;font-size:1rem;line-height:1.75rem;--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity))}p code,li code{font-weight:700;--tw-text-opacity:1;color:rgb(249 115 22/var(--tw-text-opacity))}p a:link,p a:visited{font-style:italic;--tw-text-opacity:1;color:rgb(234 88 12/var(--tw-text-opacity))}p a:link:hover,p a:visited:hover{--tw-text-opacity:1;color:rgb(154 52 18/var(--tw-text-opacity))}pre>code{display:block;overflow:auto;padding:1.5rem;font-weight:400}ul{list-style-position:inside;list-style-type:disc}ul>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}section ul ul,section ul ol,section ol ul{margin-left:1rem}ol{list-style-position:inside;list-style-type:decimal}ol>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}*,::before,::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }.container{width:100%}@media(min-width:640px){.container{max-width:640px}}@media(min-width:768px){.container{max-width:768px}}@media(min-width:1024px){.container{max-width:1024px}}@media(min-width:1280px){.container{max-width:1280px}}@media(min-width:1536px){.container{max-width:1536px}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.visible{visibility:visible}.collapse{visibility:collapse}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.\!relative{position:relative!important}.relative{position:relative}.sticky{position:sticky}.inset-y-0{top:0;bottom:0}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.top-\[3\.5rem\]{top:3.5rem}.top-\[4\.5rem\]{top:4.5rem}.isolate{isolation:isolate}.z-50{z-index:50}.-m-2{margin:-.5rem}.-m-2\.5{margin:-.625rem}.m-0{margin:0}.-mx-3{margin-left:-.75rem;margin-right:-.75rem}.-my-6{margin-top:-1.5rem;margin-bottom:-1.5rem}.mx-12{margin-left:3rem;margin-right:3rem}.mx-2{margin-left:.5rem;margin-right:.5rem}.mx-4{margin-left:1rem;margin-right:1rem}.mx-5{margin-left:1.25rem;margin-right:1.25rem}.mx-auto{margin-left:auto;margin-right:auto}.my-3{margin-top:.75rem;margin-bottom:.75rem}.my-6{margin-top:1.5rem;margin-bottom:1.5rem}.mb-0{margin-bottom:0}.mb-1{margin-bottom:.25rem}.mb-10{margin-bottom:2.5rem}.mb-12{margin-bottom:3rem}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-4{margin-left:1rem}.mt-0{margin-top:0}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-5{margin-top:1.25rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.inline{display:inline}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.flow-root{display:flow-root}.contents{display:contents}.hidden{display:none}.h-0{height:0}.h-0\.5{height:.125rem}.h-12{height:3rem}.h-4{height:1rem}.h-48{height:12rem}.h-6{height:1.5rem}.h-screen{height:100vh}.w-12{width:3rem}.w-28{width:7rem}.w-4{width:1rem}.w-48{width:12rem}.w-6{width:1.5rem}.w-64{width:16rem}.w-fit{width:-moz-fit-content;width:fit-content}.w-full{width:100%}.min-w-0{min-width:0}.min-w-\[25\%\]{min-width:25%}.min-w-\[7rem\]{min-width:7rem}.max-w-5xl{max-width:64rem}.max-w-\[1600px\]{max-width:1600px}.max-w-\[30\%\]{max-width:30%}.max-w-screen-xl{max-width:1280px}.max-w-2xl{max-width:42rem}.flex-auto{flex:auto}.flex-shrink-0{flex-shrink:0}.grow{flex-grow:1}.grow-0{flex-grow:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skewX(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;-moz-user-select:none;user-select:none}.list-disc{list-style-type:disc}.list-none{list-style-type:none}.flex-col{flex-direction:column}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.space-x-12>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(3rem * var(--tw-space-x-reverse));margin-left:calc(3rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-6>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1.5rem * var(--tw-space-x-reverse));margin-left:calc(1.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-24>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(6rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(6rem * var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-gray-200>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgb(229 231 235/var(--tw-divide-opacity))}.divide-gray-500\/10>:not([hidden])~:not([hidden]){border-color:rgb(107 114 128/.1)}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.border{border-width:1px}.border-t{border-top-width:1px}.border-gray-900\/10{border-color:rgb(17 24 39/.1)}.border-slate-300{--tw-border-opacity:1;border-color:rgb(203 213 225/var(--tw-border-opacity))}.border-slate-400{--tw-border-opacity:1;border-color:rgb(148 163 184/var(--tw-border-opacity))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.bg-\[radial-gradient\(ellipse_at_top\2c _var\(--tw-gradient-stops\)\)\]{background-image:radial-gradient(ellipse at top,var(--tw-gradient-stops))}.from-gray-800{--tw-gradient-from:#1f2937 var(--tw-gradient-from-position);--tw-gradient-to:rgb(31 41 55 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.via-gray-900{--tw-gradient-to:rgb(17 24 39 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), #111827 var(--tw-gradient-via-position), var(--tw-gradient-to)}.to-black{--tw-gradient-to:#000 var(--tw-gradient-to-position)}.p-2{padding:.5rem}.p-2\.5{padding:.625rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-10{padding-top:2.5rem;padding-bottom:2.5rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pl-0{padding-left:0}.pl-0\.5{padding-left:.125rem}.pl-1{padding-left:.25rem}.pl-3{padding-left:.75rem}.pl-4{padding-left:1rem}.pr-8{padding-right:2rem}.text-center{text-align:center}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.lowercase{text-transform:lowercase}.italic{font-style:italic}.leading-5{line-height:1.25rem}.leading-6{line-height:1.5rem}.leading-7{line-height:1.75rem}.leading-none{line-height:1}.tracking-tight{letter-spacing:-.025em}.text-gray-200{--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity))}.text-orange-500{--tw-text-opacity:1;color:rgb(249 115 22/var(--tw-text-opacity))}.text-slate-600{--tw-text-opacity:1;color:rgb(71 85 105/var(--tw-text-opacity))}.text-slate-900{--tw-text-opacity:1;color:rgb(15 23 42/var(--tw-text-opacity))}.underline{text-decoration-line:underline}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.outline{outline-style:solid}.blur{--tw-blur:blur(8px);filter:var(--tw-blur)var(--tw-brightness)var(--tw-contrast)var(--tw-grayscale)var(--tw-hue-rotate)var(--tw-invert)var(--tw-saturate)var(--tw-sepia)var(--tw-drop-shadow)}.filter{filter:var(--tw-blur)var(--tw-brightness)var(--tw-contrast)var(--tw-grayscale)var(--tw-hue-rotate)var(--tw-invert)var(--tw-saturate)var(--tw-sepia)var(--tw-drop-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms}.duration-200{transition-duration:200ms}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}.hover\:text-gray-200:hover{--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}.hover\:text-orange-500:hover{--tw-text-opacity:1;color:rgb(249 115 22/var(--tw-text-opacity))}.hover\:text-orange-600:hover{--tw-text-opacity:1;color:rgb(234 88 12/var(--tw-text-opacity))}.hover\:text-slate-800:hover{--tw-text-opacity:1;color:rgb(30 41 59/var(--tw-text-opacity))}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skewX(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.peer:checked~.peer-checked\:block{display:block}@media(min-width:640px){.sm\:max-w-sm{max-width:24rem}.sm\:px-0{padding-left:0;padding-right:0}.sm\:px-2{padding-left:.5rem;padding-right:.5rem}.sm\:py-6{padding-top:1.5rem;padding-bottom:1.5rem}.sm\:text-4xl{font-size:2.25rem;line-height:2.5rem}.sm\:ring-1{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.sm\:ring-gray-900\/10{--tw-ring-color:rgb(17 24 39 / 0.1)}}@media(min-width:768px){.md\:order-1{order:1}.md\:mt-0{margin-top:0}.md\:py-16{padding-top:4rem;padding-bottom:4rem}.md\:py-8{padding-top:2rem;padding-bottom:2rem}.md\:text-2xl{font-size:1.5rem;line-height:2rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}.md\:text-7xl{font-size:4.5rem;line-height:1}.md\:text-base{font-size:1rem;line-height:1.5rem}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}}@media(min-width:1024px){.lg\:relative{position:relative}.lg\:top-0{top:0}.lg\:mb-0{margin-bottom:0}.lg\:block{display:block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:h-auto{height:auto}.lg\:w-\[50vw\]{width:50vw}.lg\:max-w-none{max-width:none}.lg\:max-w-\[1600px\]{max-width:1600px}.lg\:flex-1{flex:1}.lg\:flex-none{flex:none}.lg\:flex-row{flex-direction:row}.lg\:justify-center{justify-content:center}.lg\:bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.lg\:px-0{padding-left:0;padding-right:0}.lg\:px-8{padding-left:2rem;padding-right:2rem}.lg\:pl-8{padding-left:2rem}.lg\:pr-0{padding-right:0}.lg\:text-sm{font-size:.875rem;line-height:1.25rem}.lg\:shadow-none{--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}}@media(min-width:1280px){.xl\:w-72{width:18rem}.xl\:px-12{padding-left:3rem;padding-right:3rem}.xl\:px-16{padding-left:4rem;padding-right:4rem}.xl\:pr-16{padding-right:4rem}}</style></head><body><header class="z-50"><nav class="flex items-end justify-between py-6 lg:px-8" aria-label="Global"><div class="flex lg:hidden pl-4"><button type="button" id="menuOpen" class="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700 hover:text-orange-500">
<span class="sr-only">Open main menu</span><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg></button></div><div class="hidden lg:flex lg:flex-1 lg:justify-center"><a href="https://im5tu.io/" class="text-sm font-semibold leading-6 text-gray-900 mx-12">Home</a>
<a href="https://im5tu.io/about/" class="text-sm font-semibold leading-6 text-gray-900 hover:text-orange-500 mx-12">About</a>
<a href="https://im5tu.io/article/" class="text-sm font-semibold leading-6 text-gray-900 hover:text-orange-500 mx-12">Articles</a>
<a href="https://im5tu.io/learn/" class="text-sm font-semibold leading-6 text-gray-900 hover:text-orange-500 mx-12">Learn</a>
<a href="https://im5tu.io/video/" class="text-sm font-semibold leading-6 text-gray-900 hover:text-orange-500 mx-12">Videos</a></div></nav><div class="lg:hidden" role="dialog" aria-modal="true"><div class="fixed inset-y-0 left-0 z-50 w-full overflow-y-auto bg-white px-6 py-6 sm:max-w-sm sm:ring-1 sm:ring-gray-900/10 hidden" id="mobileMenu"><div class="flex items-center justify-between"><button type="button" class="-m-2.5 rounded-md p-2.5 text-gray-700" id="menuClose">
<span class="sr-only">Close menu</span><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg></button></div><div class="mt-6 flow-root"><div class="-my-6 divide-y divide-gray-500/10"><div class="space-y-2 py-6"><a href="https://im5tu.io/" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:text-orange-500">Home</a>
<a href="https://im5tu.io/about/" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:text-orange-500">About</a>
<a href="https://im5tu.io/article/" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:text-orange-500">Articles</a>
<a href="https://im5tu.io/learn/" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:text-orange-500">Learn</a>
<a href="https://im5tu.io/video/" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:text-orange-500">Videos</a></div></div></div></div></div></header><main class="isolate"><div class="bg-white px-6 py-8 lg:px-8"><article itemscope itemtype="https://schema.org/BlogPosting" class="mx-auto max-w-5xl text-base leading-7 text-gray-700"><meta itemprop="wordCount" content="1772"><meta itemprop="abstract" content="In a world where we use auto-scaling a lot, its often not just one metric that we will take into consideration when deciding whether or not to scale our applications. For example, we might have a combination of CPU usage, memory usage and web request latency. Some services like AWS CloudWatch Metrics only allow scaling based off a single value. Luckily, we can blend metrics together to create new ones, which we can then use in our scaling policies. A blended metric is made up of however one or more existing metrics that you choose, called aspects, and can be published as if it were any other metric, eg: publish to DataDog/Cloudwatch."><nav class="flex mb-6" aria-label="Breadcrumb"><ol role="list" class="flex items-center space-x-4 list-none" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><meta itemprop="position" content="1"><meta itemprop="url item" content="https://im5tu.io/"><div><a href="https://im5tu.io/" class="text-gray-400 hover:text-orange-500"><svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414.0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"/></svg><span itemprop="name" class="sr-only">CodeWithStu</span></a></div></li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><meta itemprop="position" content="2"><meta itemprop="url item" content="https://im5tu.io/article/"><div class="flex items-center"><svg class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75.0 01.02-1.06L11.168 10 7.23 6.29a.75.75.0 111.04-1.08l4.5 4.25a.75.75.0 010 1.08l-4.5 4.25a.75.75.0 01-1.06-.02z" clip-rule="evenodd"/></svg><a href="https://im5tu.io/article/" class="ml-4 text-sm font-medium text-gray-500 hover:text-orange-500"><span itemprop="name">Articles</span></a></div></li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><meta itemprop="position" content="3"><meta itemprop="url item" content="https://im5tu.io/article/2020/"><div class="flex items-center"><svg class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75.0 01.02-1.06L11.168 10 7.23 6.29a.75.75.0 111.04-1.08l4.5 4.25a.75.75.0 010 1.08l-4.5 4.25a.75.75.0 01-1.06-.02z" clip-rule="evenodd"/></svg><a href="https://im5tu.io/article/2020/" class="ml-4 text-sm font-medium text-gray-500 hover:text-orange-500"><span itemprop="name">2020</span></a></div></li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><meta itemprop="position" content="4"><meta itemprop="url item" content="https://im5tu.io/article/2020/12/"><div class="flex items-center"><svg class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75.0 01.02-1.06L11.168 10 7.23 6.29a.75.75.0 111.04-1.08l4.5 4.25a.75.75.0 010 1.08l-4.5 4.25a.75.75.0 01-1.06-.02z" clip-rule="evenodd"/></svg><a class="ml-4 text-sm font-medium text-gray-500 select-none"><span itemprop="name">December</span></a></div></li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><meta itemprop="position" content="5"><div class="flex items-center"><meta itemprop="url item" content="https://im5tu.io/article/2020/12/blending-metrics-using-eventcounters-in-c/"><svg class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75.0 01.02-1.06L11.168 10 7.23 6.29a.75.75.0 111.04-1.08l4.5 4.25a.75.75.0 010 1.08l-4.5 4.25a.75.75.0 01-1.06-.02z" clip-rule="evenodd"/></svg><a class="ml-4 text-sm font-medium text-gray-500 select-none"><span itemprop="name">Blending Metrics Using EventCounters In C#</span></a></div></li></ol></nav><h1 itemprop="name headline" class="mt-2 mb-0 text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">Blending Metrics Using EventCounters In C#</h1><div><div itemprop="author" itemscope itemtype="http://schema.org/Person" id="codewithstu" class="hidden"><meta itemprop="name" content="Stuart Blackler"><meta itemprop="jobTitle" content="Principal Software Engineer"><meta itemprop="description" content="I help you grow as a developer. I love to talk about #aws, #devops, #dotnet, #aspnetcore, and #opentelemetry"><meta itemprop="knowsAbout" content="AWS, DevOps, .NET, ASP.NET Core, OpenTelemetry, C#, .Net Core, Kubernetes, XUnit, Git, Github, FluentAssertions, SQL Server, Azure, Docker, Kubernetes, Apache Kafka, Elasticsearch, Redis, SAP Business One, WCF, TFSVC"><link itemprop="sameAs" href="https://twitter.com/CodeWithStu"><link itemprop="sameAs" href="https://bsky.app/profile/codewithstu.tv"><link itemprop="sameAs" href="https://github.com/im5tu"><link itemprop="sameAs" href="https://www.linkedin.com/in/codewithstu/"><link itemprop="sameAs" href="https://www.youtube.com/@CodeWithStu"><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Illuvium.io"><meta itemprop="url" content="https://illuvium.io/"><meta itemprop="description" content="Principle C# Engineer, January 2024 - Present. London, England, United Kingdom"></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Loupe"><meta itemprop="url" content="https://loupe.work"><meta itemprop="description" content="Principal Engineer, August 2022 - December 2023. London, England, United Kingdom. Guided teams, AWS infrastructure, reduced build times, updated coding standards."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Checkout.com"><meta itemprop="url" content="https://checkout.com"><meta itemprop="description" content="Principal Engineer, March 2021 - July 2022. London, England, United Kingdom. Technical direction, auditing/security architectures, AWS Organisational Accounts, observability & security packages."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="GfK"><meta itemprop="url" content="https://https://www.gfk.com/"><meta itemprop="description" content="Senior Software Engineer (Contract), October 2018 - June 2019. Slough, United Kingdom. Migrated crawling platform to AWS, performance troubleshooting, and growth strategies."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ClearBank"><meta itemprop="url" content="https://clear.bank"><meta itemprop="description" content="Lead Architect, June 2018 - October 2018. London, United Kingdom. Designed core infrastructure, Open Banking integration, technical workshops, and customer integrations."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="4Com"><meta itemprop="url" content="https://www.4com.co.uk/"><meta itemprop="description" content=".Net Developer, September 2014 - October 2016. Bournemouth, United Kingdom. Adopted high-availability solutions, re-designed legacy architectures, and mentored junior developers."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Codestone Group Ltd"><meta itemprop="url" content="https://www.codestone.net/"><meta itemprop="description" content="Software Engineer, August 2013 - September 2014. Poole, Dorset, United Kingdom. Implemented solutions for SMEs, introduced agile processes, and mentored developers."></div><div itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Cemoc"><meta itemprop="url" content="https://www.cemoc.co.uk/"><meta itemprop="description" content="Software Developer, October 2009 - August 2012. Wootton Bridge, Isle of Wight, United Kingdom. Worked with various sized companies, responsible for product lifecycle and client support."></div><div itemprop="alumniOf" itemscope itemtype="http://schema.org/EducationalOrganization"><meta itemprop="name" content="Bournemouth University"><meta itemprop="url" href="https://www.bournemouth.ac.uk/"><meta itemprop="description" content="BSc Computing, Advanced Networking and Data Mining (2012 - 2013)"></div><div itemprop="alumniOf" itemscope itemtype="http://schema.org/EducationalOrganization"><meta itemprop="name" content="Isle of Wight College"><meta itemprop="url" href="https://www.iwcollege.ac.uk/"><meta itemprop="description" content="HND, Computer And Software Development (2008 - 2010)"></div><div itemprop="hasCredential" itemscope itemtype="http://schema.org/EducationalOccupationalCredential"><meta itemprop="name" content="MCSD: Web Applications"><meta itemprop="url" href="https://www.microsoft.com/"><meta itemprop="educationalLevel" content="Certification"><meta itemprop="recognizedBy" content="Microsoft"><meta itemprop="dateCreated" content="2014-05"></div><div itemprop="hasCredential" itemscope itemtype="http://schema.org/EducationalOccupationalCredential"><meta itemprop="name" content="MCP Programming C#"><meta itemprop="url" href="https://www.microsoft.com/"><meta itemprop="educationalLevel" content="Certification"><meta itemprop="recognizedBy" content="Microsoft"><meta itemprop="dateCreated" content="2013-06"></div><div itemprop="hasCredential" itemscope itemtype="http://schema.org/EducationalOccupationalCredential"><meta itemprop="name" content="AWS Certified Developer – Associate"><meta itemprop="url" href="https://aws.amazon.com/certification/certified-developer-associate/"><meta itemprop="educationalLevel" content="Certification"><meta itemprop="recognizedBy" content="Amazon Web Services (AWS)"><meta itemprop="dateCreated" content="2020-09"></div><div itemprop="hasCredential" itemscope itemtype="http://schema.org/EducationalOccupationalCredential"><meta itemprop="name" content="AWS Certified Solutions Architect – Associate"><meta itemprop="url" href="https://aws.amazon.com/certification/certified-solutions-architect-associate/"><meta itemprop="educationalLevel" content="Certification"><meta itemprop="recognizedBy" content="Amazon Web Services (AWS)"><meta itemprop="dateCreated" content="2020-09"></div></div><p class="font-normal text-gray-400 text-xs md:text-base italic m-0">Posted by <a itemprop="url" href="https://im5tu.io/about">Stuart Blackler</a>
on <time itemprop="datePublished" datetime="2020-12-27 12:53:17 +0000 UTC">December 27, 2020</time>.
Last Updated on <time itemprop="dateModified" datetime="2024-01-11T21:57:56Z">January 11, 2024</time>.
Tagged:<span class="inline mx-2 font-small"><a href="https://im5tu.io/%20tags/dotnet/" title="dotnet" class="hover:text-orange-500">dotnet</a></span></p></div><nav class="mb-2 bg-slate-50 p-6 w-fit rounded-lg"><h4 class="mt-0">Table of Contents</h4><ul class="space-y-1 pl-1 list-disc"><li><a class="hover:text-orange-600" href="#value-calculation">Value Calculation</a></li><li><a class="hover:text-orange-600" href="#implementation">Implementation</a></li><ul class="space-y-1 pl-4 list-disc"><li><a class="hover:text-orange-600" href="#options--validation">Options & Validation</a></li><li><a class="hover:text-orange-600" href="#extensions">Extensions</a></li></ul></ul></nav><section itemprop="articleBody"><p>In a world where we use auto-scaling a lot, its often not just one metric that we will take into consideration when deciding whether or not to scale our applications. For example, we might have a combination of CPU usage, memory usage and web request latency. Some services like AWS CloudWatch Metrics only allow scaling based off a single value. Luckily, we can blend metrics together to create new ones, which we can then use in our scaling policies. A blended metric is made up of however one or more existing metrics that you choose, called aspects, and can be published as if it were any other metric, eg: publish to DataDog/Cloudwatch.</p><p>Each aspect contains the following:</p><ul><li>Name: This is the name of the metric that you wish to track</li><li>Minimum: This indicates the lower bounds of the metric, which if breached will be kept at this value</li><li>Maximum: This indicates the upper bounds of the metric, which if breached will be kept at this value</li><li>Weighting: This increases the impact of this metric on the overall score, useful for when one metric impacts more than another</li></ul><h2 id="value-calculation">Value Calculation</h2><p>In essence there are four points to the calculation:</p><ol><li>Get the value limited by the minimum and maximum bounds</li><li>Get the value as a fraction of the maximum value</li><li>Apply the weight to the fractional value</li><li>Average all aspect values together to get the final score</li></ol><p>Let&rsquo;s walk through how this works in reality. Assume we have the following configuration:</p><ul><li>Aspect 1: Minimum=0, Maximum=100, Weighting=0, Value=50</li><li>Aspect 2: Minimum=0, Maximum=100, Weighting=1, Value=50</li></ul><p>For step 1, we need to check whether the value supplied is between the specified minimum and maximum. For this example, it is, but if the value was greater than the maximum (eg: 150), the value would be set to 100 (the maximum value allowed). The same logic applies inversely for the minimum value.</p><p>For step 2, we take the value and divide it by the maximum allowed value. This returns us a value between 0 & 1 - in our case, it&rsquo;s <code>0.5</code> for both aspects.</p><p>As we now know that step 2 returns the value <code>0.5</code> in both aspects, we can add the weighting value: <code>value = value * (1 + weighting)</code>. For aspect 1, we would end up with the calculation <code>value = 0.5 x 1 = 0.5</code>. Whereas for aspect 2, we would end up with the calculation <code>value = 0.5 x 2 = 1</code>.</p><p>For the last step, we calculate the average of the values with their weights applied, eg: <code>(0.5 + 1) / 2 = 0.75</code>. <code>0.75</code> is the value that will be reported for the metric.</p><p><em><strong>Note:</strong> An aspect&rsquo;s weighting must be between 0 and 1.</em></p><h2 id="implementation">Implementation</h2><p>The implementation I am about to show builds upon my previous work with <a href="http://localhost:1313/series/diagnostics-in-.net-core-3/">EventCounters</a> and <a href="https://im5tu.io/article/2020/12/publish-metrics-to-cloudwatch-in-.net-core/">Publishing to CloudWatch</a>, which I would encourage you to read. First, let&rsquo;s take a look at the <code>SimpleMetricObserver</code> class, which is a simple helper class that saves some of the boilerplate for the observable pattern:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleMetricObserver</span> : IObserver&lt;MetricUpdate&gt;
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;inheritDoc /&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> OnCompleted() { }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;inheritDoc /&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> OnError(Exception error) { }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;inheritDoc /&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> OnNext(MetricUpdate <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>Next, we can take a look at the implementation of <code>BlendedMetricObserver</code>. This observer is designed to listen to a series of metrics from the published metric stream I created in the <a href="https://im5tu.io/article/2020/12/publish-metrics-to-cloudwatch-in-.net-core/">CloudWatch article</a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="display:flex"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlendedMetricObserver</span> : SimpleMetricObserver, IDisposable
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> _name;
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IOptionsMonitor&lt;BlendedMetricOptions&gt; _blendedMetricOptionsMonitor;
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, BlendedMetricAspect&gt; _aspects = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, BlendedMetricAspect&gt;();
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">double</span>&gt; _values = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">double</span>&gt;();
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> List&lt;IDisposable&gt; _disposables = <span style="color:#66d9ef">new</span> List&lt;IDisposable&gt;();
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> PollingCounter? _counter = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> BlendedMetricObserver(<span style="color:#66d9ef">string</span> name, IOptionsMonitor&lt;BlendedMetricOptions&gt; blendedMetricOptionsMonitor)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        _name = name ?? <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(name));
</span></span><span style="display:flex"><span>        _blendedMetricOptionsMonitor = blendedMetricOptionsMonitor ?? <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(blendedMetricOptionsMonitor));
</span></span><span style="display:flex"><span>        _disposables.Add(_blendedMetricOptionsMonitor.OnChange(options =&gt; UpdateSettings(options)));
</span></span><span style="display:flex"><span>        UpdateSettings(_blendedMetricOptionsMonitor.Get(name));
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnNext(MetricUpdate <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">lock</span> (_values)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (!_aspects.TryGetValue(<span style="color:#66d9ef">value</span>.Name, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> aspect))
</span></span><span style="display:flex"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">var</span> filters = aspect.TagFilters.ToList();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (filters.Count == <span style="color:#ae81ff">0</span> || filters.All(x =&gt; <span style="color:#66d9ef">value</span>.Tags.Contains(x, TagFilterComparer.Instance)))
</span></span><span style="display:flex"><span>                _values[<span style="color:#66d9ef">value</span>.Name] = ConvertToWeightedValue(aspect, <span style="color:#66d9ef">value</span>.Value);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">// Exposed as protected so that we have at least some way of testing this</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">double</span> GetCurrentValue()
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">lock</span> (_values)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (_values.Count == <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#75715e">// Calculate the average of whether or not we should scale based on the weighted value of each metric</span>
</span></span><span style="display:flex"><span>            <span style="color:#75715e">// perf: do not use linq for this</span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">var</span> total = <span style="color:#ae81ff">0d</span>;
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> entry <span style="color:#66d9ef">in</span> _values)
</span></span><span style="display:flex"><span>                total += entry.Value;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">return</span> total / _values.Count;
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">double</span> ConvertToWeightedValue(BlendedMetricAspect aspect, <span style="color:#66d9ef">double</span> <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#75715e">// Get the value or the lower/upper boundary, where applicable</span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">value</span> = Math.Min(Math.Max(aspect.Minimum, <span style="color:#66d9ef">value</span>), aspect.Maximum);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#75715e">// work out the value as a fraction of the maximum value</span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">value</span> /= aspect.Maximum;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#75715e">// Add the weighting to the value</span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">value</span> *= (<span style="color:#ae81ff">1</span> + aspect.Weighting);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#75715e">// Return the value bounded by 0 and 1</span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">return</span> Math.Min(Math.Max(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">value</span>), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> UpdateSettings(BlendedMetricOptions options)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">string</span>.Equals(options.MetricName, _name))
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">lock</span> (_values)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            _aspects.Clear();
</span></span><span style="display:flex"><span>            _values.Clear();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (_counter <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex"><span>            {
</span></span><span style="display:flex"><span>                _counter = <span style="color:#66d9ef">new</span> PollingCounter(_name, MyEventSource.Instance, () =&gt; GetCurrentValue());
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>                <span style="color:#66d9ef">foreach</span> ((<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>) <span style="color:#66d9ef">in</span> options.Tags)
</span></span><span style="display:flex"><span>                    _counter.AddMetadata(key, <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex"><span>            }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> aspect <span style="color:#66d9ef">in</span> options.Aspects)
</span></span><span style="display:flex"><span>            {
</span></span><span style="display:flex"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(aspect.Name))
</span></span><span style="display:flex"><span>                    <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>                _aspects[aspect.Name] = aspect;
</span></span><span style="display:flex"><span>            }
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Dispose()
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> disposable <span style="color:#66d9ef">in</span> _disposables)
</span></span><span style="display:flex"><span>            disposable.Dispose();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        _disposables.Clear();
</span></span><span style="display:flex"><span>        _values.Clear();
</span></span><span style="display:flex"><span>        _aspects.Clear();
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagFilterComparer</span> : IEqualityComparer&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> TagFilterComparer Instance = <span style="color:#66d9ef">new</span> TagFilterComparer();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Equals(KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt; x, KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt; y)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">string</span>.Equals(x.Key, y.Key, StringComparison.Ordinal) &amp;&amp; <span style="color:#66d9ef">string</span>.Equals(x.Value, y.Value, StringComparison.Ordinal);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> GetHashCode(KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt; obj)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">return</span> HashCode.Combine(obj.Key, obj.Value);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>Let&rsquo;s break down some of the core methods. Firstly, the <code>OnNext</code> method is probably one of the most important ones as it listens to the incoming stream of metric data that is being published from our application, filtering for only the information that makes up our blended metric, before storing its value so that we can use it in the calculation portion. One thing to note in here as well, is that we can filter metrics by specific tags as well in our configuration. This means that we can re-use the same name and vary the metric by tags, much like we did in the <a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/">Capturing HTTP requests article</a>. This is where the <code>TagFilterComparer</code> comes in handy, helping to determine equality in metric tags.</p><p>The <code>ConvertToWeightedValue</code> method takes the latest stored values of each of the aspects that make up the blended metric and performs the value calculation as described earlier in the article. This method is called periodically, depending on interval set by the <code>EnableEvents</code> call on the EventSource that we are registering the blended metric against. You can see how to do that <a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/#detecting-eventsources">here</a>.</p><p>Lastly, the <code>UpdateSettings</code> method is responsible for (re)creating the polling counter which will refresh on the specified interval that has been setup on the EventSource (eg: every second). Whilst</p><h3 id="options--validation">Options & Validation</h3><p>As you may have seen above, we have a specific options class that we use to track the different options of the blended metric:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="display:flex"><span><span style="color:#75715e">/// &lt;summary&gt;Represents a metric that is made up of one or more metrics&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlendedMetricOptions</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The name to send the metric through as&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string?</span> MetricName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;A collection of metrics that make up the blended metric&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;BlendedMetricAspect&gt; Aspects { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = Enumerable.Empty&lt;BlendedMetricAspect&gt;();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The tags that should be applied to the blended metric&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt; Tags { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = Enumerable.Empty&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;();
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#75715e">/// &lt;summary&gt;Represents a part that makes up the blended metric&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlendedMetricAspect</span>
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The full name of the metric&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string?</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The lower limit of the metric. If the value is less than this value, it is set to this value.&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Minimum { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The upper limit of the metric. If the value is greater than this value, it is set to this value.&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Maximum { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;The weighting that&#39;s applied to the metric&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Weighting { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;Filters a metric where the specified tags are present&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt; TagFilters = Enumerable.Empty&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> BlendedMetricAspect()
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> BlendedMetricAspect(<span style="color:#66d9ef">string</span> name, <span style="color:#66d9ef">double</span> minimum = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">double</span> maximum = <span style="color:#ae81ff">100</span>, <span style="color:#66d9ef">double</span> weighting = <span style="color:#ae81ff">0</span>, IEnumerable&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;? tagFilters = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        Name = name;
</span></span><span style="display:flex"><span>        Minimum = minimum;
</span></span><span style="display:flex"><span>        Maximum = maximum;
</span></span><span style="display:flex"><span>        Weighting = weighting;
</span></span><span style="display:flex"><span>        TagFilters = tagFilters ?? Enumerable.Empty&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;();
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#75715e">/// &lt;summary&gt;Factory function for creating a new instance&lt;/summary&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> BlendedMetricAspect Create(<span style="color:#66d9ef">string</span> name, <span style="color:#66d9ef">double</span> minimum = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">double</span> maximum = <span style="color:#ae81ff">100</span>, <span style="color:#66d9ef">double</span> weighting = <span style="color:#ae81ff">0</span>, IEnumerable&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;? tagFilters = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex"><span>        =&gt; <span style="color:#66d9ef">new</span> BlendedMetricAspect(name, minimum, maximum, weighting, tagFilters);
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>For completeness, I&rsquo;ve included a simple options validator to ensure that we stick within some of the basic rules that we described earlier. This validation is bound to our IoC container in the next section.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="display:flex"><span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlendedMetricOptionsValidation</span> : IValidateOptions&lt;BlendedMetricOptions&gt;
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">public</span> ValidateOptionsResult Validate(<span style="color:#66d9ef">string</span> name, BlendedMetricOptions options)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">var</span> failures = Validate(options.Aspects);
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">return</span> failures.Count &gt; <span style="color:#ae81ff">0</span> ? ValidateOptionsResult.Fail(failures) : ValidateOptionsResult.Success;
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> List&lt;<span style="color:#66d9ef">string</span>&gt; Validate(IEnumerable&lt;BlendedMetricAspect&gt; aspects)
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">var</span> failures = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">var</span> aspectLst = aspects.ToList();
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> aspect <span style="color:#66d9ef">in</span> aspectLst)
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(aspect.Name))
</span></span><span style="display:flex"><span>                failures.Add(<span style="color:#e6db74">$&#34;{nameof(BlendedMetricAspect.Name)} cannot be null, empty or whitespace. Index: {aspectLst.IndexOf(aspect)}&#34;</span>);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (aspect.Minimum &gt;= aspect.Maximum)
</span></span><span style="display:flex"><span>                failures.Add(<span style="color:#e6db74">$&#34;Aspect: {aspect.Name} - {nameof(BlendedMetricAspect.Minimum)} (Current: {aspect.Minimum}) must be less than {nameof(BlendedMetricAspect.Maximum)} (Current: {aspect.Maximum}).&#34;</span>);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>            <span style="color:#66d9ef">if</span> (aspect.Weighting &lt; <span style="color:#ae81ff">0</span> || aspect.Weighting &gt; <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex"><span>                failures.Add(<span style="color:#e6db74">$&#34;Aspect: {aspect.Name} - {nameof(BlendedMetricAspect.Weighting)} must be between 0 &amp; 1. Current: {aspect.Weighting}&#34;</span>);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">return</span> failures;
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><h3 id="extensions">Extensions</h3><p>The last part of our implementation is to add some helpful <a href="https://im5tu.io/article/2012/12/extension-methods-in-dotnet/">extension methods</a> for configuring new blended metrics in our IoC containers. These methods bind the necessary components and allow you to configure one or more blended metrics either from configuration or from passing the information into the method:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IServiceCollection AddBlendedMetrics(<span style="color:#66d9ef">this</span> IServiceCollection services, IConfigurationSection configurationSection)
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> section <span style="color:#66d9ef">in</span> configurationSection.GetChildren())
</span></span><span style="display:flex"><span>        services.AddBlendedMetric(section.Key, options =&gt;
</span></span><span style="display:flex"><span>        {
</span></span><span style="display:flex"><span>            options.MetricName = section.Key;
</span></span><span style="display:flex"><span>            configurationSection.Bind(options);
</span></span><span style="display:flex"><span>        });
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> services;
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IServiceCollection AddBlendedMetric(<span style="color:#66d9ef">this</span> IServiceCollection services, <span style="color:#66d9ef">string</span> name, Action&lt;BlendedMetricOptions&gt; configurationAction)
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(name))
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(name));
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    name = name.ToLowerInvariant().Replace(<span style="color:#e6db74">&#34;_&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>).Replace(<span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    services.TryAddSingleton&lt;IValidateOptions&lt;BlendedMetricOptions&gt;, BlendedMetricOptionsValidation&gt;();
</span></span><span style="display:flex"><span>    services.AddSingleton&lt;IObserver&lt;MetricUpdate&gt;&gt;(sp =&gt; ActivatorUtilities.CreateInstance&lt;BlendedMetricObserver&gt;(sp, name));
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> services.Configure&lt;BlendedMetricOptions&gt;(name, configurationAction);
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IServiceCollection AddBlendedMetric(<span style="color:#66d9ef">this</span> IServiceCollection services, <span style="color:#66d9ef">string</span> name, Func&lt;IEnumerable&lt;BlendedMetricAspect&gt;&gt; aspects, IEnumerable&lt;KeyValuePair&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;&gt;? dimensions = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">return</span> services.AddBlendedMetric(name, options =&gt;
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>        options.MetricName = name;
</span></span><span style="display:flex"><span>        options.Aspects = options.Aspects.Concat(aspects()).ToList();
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">if</span> (dimensions <span style="color:#66d9ef">is</span> {})
</span></span><span style="display:flex"><span>            options.Tags = dimensions.ToList();
</span></span><span style="display:flex"><span>    });
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>That pretty much wraps up our basic implementation of blended metrics. With the complete implementation, we should have our metrics published to our provider of choice. I hope you can see how useful they can be when combined with things like auto-scaling. Enjoy!</p></section><div class="mt-4 border-t border-slate-400"><p><a href="https://im5tu.io/about/" title="About Stuart Blackler">Stuart Blackler</a> is a seasoned technologist with over 15 years of commercial experience in the .NET ecosystem.
Holding a degree in Computer Science, Stuart has earned
certifications as a C# developer through Microsoft and as an AWS Solutions Architect and Developer. Stuart is
the creator of the popular YouTube channel <a href="https://youtube.com/@codewithstu">CodeWithStu</a>, where he delves into topics close to his heart, including .NET, AWS, DevOps,
and software architecture with a commitment to sharing knowledge and fostering a community of learners.</p></div></article></div></main><footer class="border-t border-gray-900/10 py-12 sm:py-6 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black"><div><div class="hidden lg:flex lg:flex-1 justify-center mb-12"><a href="https://im5tu.io/" class="text-sm font-semibold leading-6 text-gray-400 hover:text-gray-200 mx-4">Home</a>
<a href="https://im5tu.io/about/" class="text-sm font-semibold leading-6 text-gray-400 hover:text-gray-200 mx-4">About</a>
<a href="https://im5tu.io/article/" class="text-sm font-semibold leading-6 text-gray-400 hover:text-gray-200 mx-4">Articles</a>
<a href="https://im5tu.io/learn/" class="text-sm font-semibold leading-6 text-gray-400 hover:text-gray-200 mx-4">Learn</a>
<a href="https://im5tu.io/video/" class="text-sm font-semibold leading-6 text-gray-400 hover:text-gray-200 mx-4">Videos</a></div><div class="flex justify-center space-x-12 my-6"><a href="https://www.youtube.com/@CodeWithStu?sub_confirmation=1" class="text-gray-400 hover:text-orange-500" target="_blank" title="Subscribe To Me On YouTube"><svg class="h-6 w-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></svg></a><a href="https://www.linkedin.com/in/im5tu" class="text-gray-400 hover:text-orange-500" target="_blank" title="Connect With Me LinkedIn"><svg class="h-6 w-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.98 3.5C4.98 4.881 3.87 6 2.5 6s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zM5 8H0v16h5V8zm7.982.0H8.014v16h4.969v-8.399c0-4.67 6.029-5.052 6.029.0V24H24V13.869c0-7.88-8.922-7.593-11.018-3.714V8z"/></svg></a><a href="https://github.com/im5tu" class="text-gray-400 hover:text-orange-500" target="_blank" title="Follow Me On GitHub"><svg class="h-6 w-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg></a></div><div class="mt-8 md:order-1 md:mt-0"><p class="text-center text-xs leading-5 text-gray-500">&copy; 2023 <a href="https://im5tu.io/" class="hover:text-orange-500">im5tu.io</a> - All rights reserved.</p></div></div></footer><script>document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("menuOpen"),t=document.getElementById("menuClose"),n=document.getElementById("mobileMenu");t&&e&&(t.addEventListener("click",e=>{n.classList.toggle("hidden"),e.preventDefault()}),e.addEventListener("click",e=>{n.classList.toggle("hidden"),e.preventDefault()}))})</script></body></html>
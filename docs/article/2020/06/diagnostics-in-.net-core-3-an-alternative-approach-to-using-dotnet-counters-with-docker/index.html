<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Stuart Blackler "><meta name="description" content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta name="keywords" content=",aspnet,dotnet,diagnostics"><meta name="robots" content="noodp"><meta name="theme-color" content><link rel="canonical" href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/"><title>Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker :: CodeWithStu's Blog</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://im5tu.io/main.2a064c455b0ecbd6b1481b3bf9df2441e95838691022f40a5338c2cb1244f075.css" integrity="sha256-KgZMRVsOy9axSBs7+d8kQelYOGkQIvQKUzjCyxJE8HU="><link rel="apple-touch-icon" sizes="180x180" href="https://im5tu.io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://im5tu.io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://im5tu.io/favicon-16x16.png"><link rel="manifest" href="https://im5tu.io/site.webmanifest"><link rel="mask-icon" href="https://im5tu.io/safari-pinned-tab.svg" color><link rel="shortcut icon" href="https://im5tu.io/favicon.ico"><meta name="msapplication-TileColor" content><meta itemprop="name" content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta itemprop="description" content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta itemprop="datePublished" content="2020-06-25T22:56:00+01:00"><meta itemprop="dateModified" content="2020-06-25T22:56:00+01:00"><meta itemprop="wordCount" content="688"><meta itemprop="keywords" content="aspnet,dotnet,diagnostics,"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta name="twitter:description" content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta property="og:title" content="Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker"><meta property="og:description" content="A look into the EventCounters API in .Net Core 3, and seeing how we can capture inbound HTTP Requests."><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/"><meta property="article:section" content="article"><meta property="article:published_time" content="2020-06-25T22:56:00+01:00"><meta property="article:modified_time" content="2020-06-25T22:56:00+01:00"><meta property="og:see_also" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/"><meta property="og:see_also" content="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/"><meta property="og:see_also" content="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/"><meta property="og:see_also" content="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/"><meta property="article:section" content="Development"><meta property="article:published_time" content="2020-06-25 22:56:00 +0100 +0100"><link rel="alternate" type="application/rss+xml" href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/index.xml" title="CodeWithStu's Blog"><meta property="og:image" content="https://im5tu.io/img/profile.png"><meta property="og:site_name" content="CodeWithStu's Blog"><link rel="alternate" type="application/rss+xml" href="https://im5tu.io/index.xml" title="Stuart Blackler's Blog"><link rel="preconnect" href="https://api.github.com"><link rel="preconnect" href="https://partner.googleadservices.com"><link rel="preconnect" href="https://tpc.googlesyndication.com"><link rel="preconnect" href="https://www.googletagservices.com"><link rel="preconnect" href="https://googleads.g.doubleclick.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Bold.woff2"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Regular.woff2"><style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2{margin-top:1.5em}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}#promotions img{margin:20px auto}#sponsorMessage{width:100%;background:#ffdf00;color:#242325;padding:10px;font-size:.9em}.flex-container{width:100%;display:inline-flex;justify-content:space-between}.flex-box{display:block}.hidden{display:hidden}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QLMVXHCJ5K"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QLMVXHCJ5K")</script><script data-ad-client="ca-pub-8597760177900459" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div class="container"><header class="header"><span class="header__inner"><a href="https://im5tu.io/" style="text-decoration:none"><div class="logo"><span class="logo__mark">></span>
<span class="logo__text">im5tu.io</span>
<span class="logo__cursor"></span></div></a><span class="header__right"><nav class="menu"><ul class="menu__inner"><li><a href="https://im5tu.io/article/">Blog</a></li><li><a href="https://news.codewithstu.tv">Newsletter</a></li><li><a href="https://www.patreon.com/CodeWithStu">Patreon</a></li><li><a href="https://im5tu.io/article/index.xml">RSS</a></li><li><a href="https://twitter.com/CodeWithStu">Twitter</a></li><li><a href="https://codewithstu.tv">YouTube</a></li></ul></nav><span class="menu-trigger"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class="content"><main class="post"><div style="font-style:italic;width:100%;background-color:#ffe12b;color:#333;text-align:center;padding:1px"><p>This page is available to sponsor. <a id="sponsorLink" href="https://im5tu.io/sponsorship/" ref="nofollow" target="_blank">Click Here</a> for more details!</p></div><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class="post-title"><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-an-alternative-approach-to-using-dotnet-counters-with-docker/">Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker</a></h1><hr><aside id="toc"><div class="toc-title">Table of Contents</div><nav id="TableOfContents"><ul><li><a href="#installing-the-net-tools">Installing the .Net tools</a></li><li><a href="#accessing-the-tools-at-runtime">Accessing the tools at runtime</a></li></ul></nav></aside><hr><div class="post-content"><div style="font-style:italic;width:100%;background-color:#63e5ff;color:#333;text-align:center;padding:5px"><p>This post is part of the <a href="#series" style="font-weight:700">Diagnostics in .Net Core 3</a> series.</p></div><p>In a <a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/">previous article</a>, we took a look at a way to use <code>dotnet-counters</code> with an external image. This article takes a look at how we can embed the tooling that we require into the image so that we extract the counter/memory information as required. This approach does not require elevated permissions as before.</p><p>Let&rsquo;s assume that we are starting with the following dockerfile:</p><pre><code class="language-dockerfile"># Publish the application using the SDK
FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build
WORKDIR /app
RUN dotnet new webapp -n BlogApp
RUN dotnet publish /app/BlogApp/BlogApp.csproj -c Release -o /out /p:GenerateDocumentationFile=false

# Build the smaller runtime image
FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine
WORKDIR /app
COPY --from=build /out ./
EXPOSE 5000
ENTRYPOINT [&quot;dotnet&quot;, &quot;BlogApp.dll&quot;]
</code></pre><p>Here we use a docker multi-stage build to publish our application (which is also created inline for the purposes of this article). Once the code has been published, we can then make the a runtime image which has a lot less dependencies, thus a smaller image size, to host the published version of the application.</p><p><strong>Note:</strong> <em>If you don&rsquo;t use the same OS, like Alpine, on both steps, then you should specify the <code>-r</code> flag with the runtime identifier for the runtime image.</em></p><h2 id="installing-the-net-tools">Installing the .Net tools</h2><p>In order to embed the tooling inside of the runtime image, we first need to adapt our build image:</p><pre><code class="language-dockerfile"># Publish the application using the SDK
FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build
WORKDIR /app
RUN dotnet new webapp -n BlogApp
RUN dotnet publish /app/BlogApp/BlogApp.csproj -c Release -o /out /p:GenerateDocumentationFile=false
# NEW CODE
RUN dotnet tool install dotnet-dump --tool-path /tools
RUN dotnet tool install dotnet-counters --tool-path /tools
RUN dotnet tool install dotnet-trace --tool-path /tools
# END OF NEW CODE
</code></pre><p>Here we leverage the dotnet tools ability to restore tooling to a specific directory, in this case <code>/tools</code>. Once the tools have been installed, we can copy them into the runtime image:</p><pre><code class="language-dockerfile"># Build the smaller runtime image
FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine
WORKDIR /app
COPY --from=build /out ./
EXPOSE 5000
# NEW CODE
COPY --from=build /tools /tools
ENV PATH=&quot;/tools:${PATH}&quot;
# END OF NEW CODE
ENTRYPOINT [&quot;dotnet&quot;, &quot;BlogApp.dll&quot;]
</code></pre><h2 id="accessing-the-tools-at-runtime">Accessing the tools at runtime</h2><p>In order to access these tools at runtime, we need to be able to access the container at runtime. An example of this is being able to SSH into the running EC2 instance on AWS. Assuming that we have access, we can run the following command to get the running containers:</p><pre><code class="language-bash">docker ps
</code></pre><p>Which results in output similar to the following:</p><pre><code class="language-bash">CONTAINER ID  IMAGE             COMMAND                  CREATED        STATUS                    PORTS                NAMES
fac2377f3e87  myContainerImage  &quot;./usr/src/app/init.…&quot;   30 hours ago   Up 55 seconds (healthy)   0.0.0.0:80-&gt;80/tcp   myContainerImage
</code></pre><p>From here, we can use the <a href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a> command to launch a shell in the new container, using the container ID from above:</p><pre><code class="language-bash">docker exec -it -w /tools &lt;ID&gt; /bin/sh
#Example:
docker exec -it -w /tools fac2377f3e87 /bin/sh
</code></pre><p><code>-it</code> tells docker that we want the shell to be interactive and to keep the shell open for us even when there is no immediate input, ie: we can type into it and get a response. <code>-w</code> means start in the working directory <code>/tools</code>. Next, replace <code>&lt;ID></code> with the container ID from the selection above. Finally, we pass in the command that we want to execute in the shell - which we open a shell so that we can run different commands.</p><p>Now you should be able to run <code>dotnet-counters</code>, <code>dotnet-dump</code> & <code>dotnet-trace</code> as normal. If you need to copy any files from the container then you need to run the following from the host machine:</p><pre><code class="language-bash">docker cp &lt;ID&gt;:&lt;path-to-file-in-container&gt; &lt;copy-to-path-on-host&gt;
#Example:
docker cp fac2377f3e87:/tools/output/trace.nettrace ./output/trace.nettrace
</code></pre><p>The <a href="https://docs.docker.com/engine/reference/commandline/cp/">docker cp</a> command allows us to copy a file from/to the running container (specified by <code>&lt;ID></code>). The only other thing that you need is the path of the file that you wish to copy from the container, and the destination path on the host machine.</p><p>Now you&rsquo;ll have the diagnostic tools embedded within your runtime images, at the correct version. Naturally, the more tools that you install, the larger the final size of the image will be. It does also take a little bit of prep work, but this can pay off massively for unexpected memory/cpu issues. Happy diagnosing.</p></div></article><hr><div id="recommended"><h4>Book Recommendations</h4><p><i>The books below are ones I would personally buy again. All links are redirect to Amazon.</i></p><div class="flex-container"><div class="flex-box"><a href="https://geni.us/P3Jlg4" target="_blank" ref="nofollow"><img src="https://im5tu.io/img/affiliates/Book1.jpg" width="150" height="200" alt="Writing High Performance .NET Code"></a></div><div class="flex-box"><a href="https://geni.us/qEg8Cx" target="_blank" ref="nofollow"><img src="https://im5tu.io/img/affiliates/Book2.jpg" width="150" height="200" alt="Pro .NET Memory Management"></a></div><div class="flex-box"><a href="https://geni.us/k8HBxBA" target="_blank" ref="nofollow"><img src="https://im5tu.io/img/affiliates/Book3.jpg" width="150" height="200" alt="Pro .NET Benchmarking"></a></div><div class="flex-box"><a href="https://geni.us/4b2QcS" target="_blank" ref="nofollow"><img src="https://im5tu.io/img/affiliates/Book4.jpg" width="150" height="200" alt="Designing Data-Intensive Applications"></a></div></div></div><hr><div class="post-info"><a name="series"></a>
<b>More in the Diagnostics in .Net Core 3 series:</b><ol><li><a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-event-counters/">Diagnostics in .Net Core 3: Event Counters</a></li><li><a href="https://im5tu.io/article/2020/01/diagnostics-in-.net-core-3-using-dotnet-counters-with-docker/">Diagnostics in .Net Core 3: Using dotnet-counters with Docker</a></li><li><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-outbound-http-requests/">Diagnostics in .Net Core 3: Listening to outbound HTTP requests</a></li><li><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/">Diagnostics in .Net Core 3: Listening to inbound HTTP requests</a></li><li><b>Diagnostics in .Net Core 3: An alternative approach to using dotnet-counters with Docker <i>(This article)</i></b></li></ol><p><a href="https://im5tu.io/series/diagnostics-in-.net-core-3/">View All Articles</a></p><hr><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class="tag"><a href="https://im5tu.io/tags/aspnet/">aspnet</a></span><span class="tag"><a href="https://im5tu.io/tags/dotnet/">dotnet</a></span><span class="tag"><a href="https://im5tu.io/tags/diagnostics/">diagnostics</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>688 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-06-25 21:56 +0000</p></div><hr><div id="promotions"><h4>Offers From My Partners</h4><a href="https://geni.us/cws-springer" target="_blank"><img src="https://www.awltovhc.com/image-100677210-11635960" width="468" height="60" alt="10% Off Shop Now!"></a>
<a href="https://geni.us/cws-namecheap" target="_blank"><img src="https://www.awltovhc.com/image-100677210-14326263" width="728" height="90" alt="Popular Domains for just 99 Cents at Namecheap!"></a></div><hr><script src="https://utteranc.es/client.js" repo="Im5tu/im5tu.github.io" issue-term="url" label="Comment" theme="photon-dark" crossorigin="anonymous" async></script><div class="pagination"><div class="pagination__title"><span class="pagination__title-h"></span><hr></div><div class="pagination__buttons"><span class="button previous"><a href="https://im5tu.io/article/2020/07/my-favourite-git-aliases/"><span class="button__icon">←</span>
<span class="button__text">My Favourite Git Aliases</span></a></span>
<span class="button next"><a href="https://im5tu.io/article/2020/06/diagnostics-in-.net-core-3-listening-to-inbound-http-requests/"><span class="button__text">Diagnostics in .Net Core 3: Listening to inbound HTTP requests</span>
<span class="button__icon">→</span></a></span></div></div></main></div><footer class="footer"><hr><div class="footer__inner"><div class="footer__content"><iframe src="https://codewithstu.substack.com/embed" width="480" height="320" style="border:1px solid #eee;background:#fff" frameborder="0" scrolling="no"></iframe></div></div><hr><div><div class="footer__inner"><div class="footer__content"><span>&copy; 2023</span>
<span><a href="https://im5tu.io/">Stuart Blackler</a></span>
<span><a href="https://im5tu.io/article/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div><p><a href="https://im5tu.io/tags">Tags</a> | <a href="https://im5tu.io/categories">Categories</a> | <a href="https://im5tu.io/sitemap.xml">Sitemap</a></p></div><div><p>This site uses Google Analytics for Analytics only, so may contain cookies.</p></div></div></footer></div><script type="text/javascript" src="https://im5tu.io/bundle.min.c90b8161416b87c69a8e02683b54ddd6edb90aea699648bf655e6cbc45b419b8e465d196e715772463dba35a6faf5decb2eb247480d38680484d54645b434570.js" integrity="sha512-yQuBYUFrh8aajgJoO1Td1u25Cupplki/ZV5svEW0GbjkZdGW5xV3JGPbo1pvr13ssuskdIDThoBITVRkW0NFcA=="></script>
<script src="https://im5tu.io/js/site-376a1eef.js" defer></script></body></html>
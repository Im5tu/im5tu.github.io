<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="Stuart Blackler ">
<meta name=description content="Learn how to publish a private helm repository using Github Pages Enterprise">
<meta name=keywords content=",k8s,helm,Github">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/>
<title>
Creating a private helm repository using Github Pages Enterprise :: Stuart Blackler's Blog
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<meta name=msapplication-TileColor content>
<meta itemprop=name content="Creating a private helm repository using Github Pages Enterprise">
<meta itemprop=description content="Learn how to publish a private helm repository using Github Pages Enterprise"><meta itemprop=datePublished content="2022-01-15T22:15:00+00:00">
<meta itemprop=dateModified content="2022-01-15T22:15:00+00:00">
<meta itemprop=wordCount content="984">
<meta itemprop=keywords content="k8s,helm,Github,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Creating a private helm repository using Github Pages Enterprise">
<meta name=twitter:description content="Learn how to publish a private helm repository using Github Pages Enterprise">
<meta property="og:title" content="Creating a private helm repository using Github Pages Enterprise">
<meta property="og:description" content="Learn how to publish a private helm repository using Github Pages Enterprise">
<meta property="og:type" content="article">
<meta property="og:url" content="https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/"><meta property="article:section" content="article">
<meta property="article:published_time" content="2022-01-15T22:15:00+00:00">
<meta property="article:modified_time" content="2022-01-15T22:15:00+00:00">
<meta property="article:section" content="k8s">
<meta property="article:section" content="helm">
<meta property="article:section" content="Github">
<meta property="article:published_time" content="2022-01-15 22:15:00 +0000 UTC">
<link rel=alternate type=application/rss+xml href=https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/index.xml title="Stuart Blackler's Blog">
<meta property="og:image" content="https://im5tu.io/img/profile.jpg">
<meta property="og:site_name" content="Stuart Blackler's Blog">
<link rel=alternate type=application/rss+xml href=/index.xml title="Stuart Blackler's Blog">
<link rel=preconnect href=https://api.github.com>
<link rel=preconnect href=https://partner.googleadservices.com>
<link rel=preconnect href=https://tpc.googlesyndication.com>
<link rel=preconnect href=https://www.googletagservices.com>
<link rel=preconnect href=https://googleads.g.doubleclick.net>
<link rel=preconnect href=https://pagead2.googlesyndication.com>
<link rel=preload href=/fonts/Inter-UI-Bold.woff2>
<link rel=preload href=/fonts/Inter-UI-Regular.woff2>
<style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}#promotions img{margin:20px auto}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QLMVXHCJ5K"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QLMVXHCJ5K')</script>
<script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>im5tu.io</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=/article/>Articles</a></li><li><a href=https://news.codewithstu.tv>FREE Stuff!</a></li><li><a href=/article/index.xml>RSS Feed</a></li><li><a href=https://github.com/sponsors/Im5tu>Sponsor</a></li><li><a href=https://bit.ly/im5tu-tw>Twitter</a></li><li><a href=https://bit.ly/im5tu-yt>YouTube</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/>Creating a private helm repository using Github Pages Enterprise</a>
</h1>
<hr>
<aside id=toc>
<div class=toc-title>Table of Contents</div>
<nav id=TableOfContents>
<ul>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#setup-github-pages>Setup Github Pages</a></li>
<li><a href=#publish-action>Publish Action</a></li>
<li><a href=#using-with-helm>Using with Helm</a></li>
</ul>
</nav>
</aside>
<hr>
<div class=post-content>
<p>In this article, we&rsquo;re going to take a look at how to create a private Helm repository with Github Pages. This guide requires you to have a Github Enterprise license as private Github Pages are only available to enterprise customers. I&rsquo;m showing this approach for the scenarios where setting up something like <a href=https://chartmuseum.com/>ChartMuseum</a> isn&rsquo;t possible or unwanted. Although this guide uses helm as the example, you can extend this to host anything under a privately authenticated Github page.</p>
<h2 id=prerequisites>Prerequisites</h2>
<p>For this approach to work, you need to have the following in place:</p>
<ol>
<li>A private Github repository as part of a <a href=https://github.com/enterprise>Github Enterprise</a></li>
<li>2 branches setup in the repository:
<ul>
<li>main - This is where your chart source lives</li>
<li>gh-pages - This is where the charts are published</li>
</ul>
</li>
<li>A personal access token (PAT) that can access the repository</li>
</ol>
<h2 id=setup-github-pages>Setup Github Pages</h2>
<p>Once you have the prerequisites in place, you will need to setup your Github Pages with the following settings:</p>
<p><img src=/img/helm-private-github-pages/Pages-Setup.png alt="Github Pages Setup"></p>
<p>The key parts of the setup are:</p>
<ol>
<li>Ensure that the repository pages are set to private</li>
<li>The branch is set to <code>gh-pages</code> at the root</li>
</ol>
<p>Please note that your URL that Github generates for you will be different and you do not actually need this URL for the rest of the tutorial.</p>
<h2 id=publish-action>Publish Action</h2>
<p>Helm relies on an index file that tells us the location of all the charts for a given repository and provides their download links. To build our index, we need to update it as soon as we push to the <code>main</code> branch. Let&rsquo;s take a look at the following Github Action:</p>
<pre><code class=language-yaml>name: Release Helm Charts

# Do not change this
concurrency: release-helm

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: 'src'
          fetch-depth: 0
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: 'dest'
          ref: 'gh-pages'
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v1

      - name: Package Helm Charts
        shell: bash
        run: |
          find src/charts/ -type f -name 'Chart.yaml' | sed -r 's|/[^/]+$||' | sort | uniq | xargs -L 1 helm dep up
          for d in src/charts/*/ ; do
              echo &quot;$d&quot;
              helm package &quot;$d&quot; -u -d dest
          done
      - name: Push New Files
        shell: bash
        working-directory: dest
        run: |
          helm repo index . --url https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/
          git config user.name &quot;Helm Updater&quot;
          git config user.email &quot;actions@users.noreply.github.com&quot;
          git add $(git ls-files -o --exclude-standard)
          git add index.yaml
          git commit -m &quot;Updated from ref: $GITHUB_SHA&quot;
          git push
</code></pre>
<p>Starting from the top, we have <code>concurrency: release-helm</code>. This tells Github that only a single instance of this action should be run as once, this is because later on we will be publishing the action to a different branch and git will get confused if we tried to do this in parallel. Next, we checkout two different branches, one for <code>main</code> and one for <code>gh-pages</code>:</p>
<pre><code class=language-yaml>- name: Checkout
  uses: actions/checkout@v2
  with:
    path: 'src'
    fetch-depth: 0
- name: Checkout
  uses: actions/checkout@v2
  with:
    path: 'dest'
    ref: 'gh-pages'
    fetch-depth: 0
</code></pre>
<p>This is so that we can easily use standard git commands to push files to a branch. The next interesting part is where we package the helm charts:</p>
<pre><code class=language-yaml>- name: Package Helm Charts
  shell: bash
  run: |
      find src/charts/ -type f -name 'Chart.yaml' | sed -r 's|/[^/]+$||' | sort | uniq | xargs -L 1 helm dep up
      for d in src/charts/*/ ; do
          echo &quot;$d&quot;
          helm package &quot;$d&quot; -u -d dest
      done
</code></pre>
<p>Here we look in the charts directory of <code>src</code>, which is where we cloned our <code>main</code> branch in to, and run <code>helm dep up</code> on each of the charts that we find, including subcharts. This ensures that we have everything that we need to package the chart.</p>
<p>When packaging the chart, we put it in the <code>dest</code> folder which is the folder we cloned our <code>gh-pages</code> branch to. This contains all of the charts from the <code>main</code> branch packaged alongside the helm index file.</p>
<p>In order to commit all of this back to git we use the following set of commands:</p>
<pre><code class=language-yaml>- name: Push New Files
  shell: bash
  working-directory: dest
  run: |
      helm repo index . --url https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/
      git config user.name &quot;Helm Updater&quot;
      git config user.email &quot;actions@users.noreply.github.com&quot;
      git add $(git ls-files -o --exclude-standard)
      git add index.yaml
      git commit -m &quot;Updated from ref: $GITHUB_SHA&quot;
      git push
</code></pre>
<p><code>helm repo index</code> creates the new index file, or updates it when it already exists, based on the contents of the <code>gh-pages</code> branch. Note the URL that&rsquo;s specified, which means that all content comes from here. Without this, helm will not work. It also <strong>must</strong> be a <code>raw.githubusercontent.com</code> address not the randomly generated URL from the pages settings. This is because this endpoint supports the basic authentication required for the private feed.</p>
<p><code>git add $(git ls-files -o --exclude-standard)</code> basically tells git to add any files that it thinks have been changed/added, before we run standard git commands to commit and push. To push, we do need to specify the name/email of the user that&rsquo;s committing, though this can be anything that you want.</p>
<p>Once the action has published, you should be able to access the generated helm index in your browser (you may need to authenticate with your normal github login or with your PAT token):</p>
<p><img src=/img/helm-private-github-pages/Uploaded-Index.png alt="Generated helm index"></p>
<p>And you&rsquo;ll see this in your repository on the <code>gh-pages</code> branch:</p>
<p><img src=/img/helm-private-github-pages/Repository-Contents.png alt="Generated Repository Contents"></p>
<h2 id=using-with-helm>Using with Helm</h2>
<p>To use the generated index with helm, you need to supply the <code>https://raw.githubusercontent.com</code> address we used earlier to helm, along with your username and generated PAT token:</p>
<pre><code class=language-bash>helm repo add private https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/ --username &lt;Your Username&gt; --password &lt;Your PAT token&gt;
helm repo update
</code></pre>
<p>This will use Github basic authentication to pull the index and allow you to search and use the repository. The result will look something similar to the following:</p>
<pre><code class=language-bash>&gt; helm search repo private       
NAME                    CHART VERSION   APP VERSION     DESCRIPTION       
private/generic-service 0.0.1           0.0.2           Generic Helm Chart
</code></pre>
<p>From here you are free to use your new helm repository as if it was any other helm repository. Enjoy!</p>
</div>
</article>
<hr>
<div style=text-align:center>
<p><i>To get all the latest news from me, <b><a href=https://news.codewithstu.tv>subscribe</a></b> to my new newsletter, <b>Observed!</b>. On my YouTube channel <b><a href=https://codewithstu.tv>CodeWithStu</a></b> you'll find different tip, tricks and tutorials using some of the latest technologies, in bitesize chunks.</i></p>
</div>
<hr>
<div id=promotions>
<a href=https://bit.ly/3IOmG1h target=_blank>
<img src=https://www.ftjcfx.com/image-100677210-15265410 width=728 height=90 alt="Save now"></a>
<a href=https://www.anrdoezrs.net/click-100677210-14326263 target=_blank>
<img src=https://www.lduhtrp.net/image-100677210-14326263 width=728 height=90 alt="Popular Domains for just 99 Cents at Namecheap!"></a>
</div>
<hr>
<div class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://im5tu.io/tags/k8s>k8s</a></span><span class=tag><a href=https://im5tu.io/tags/helm>helm</a></span><span class=tag><a href=https://im5tu.io/tags/github>Github</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>984 Words</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-01-15 22:15 +0000</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://im5tu.io/article/2022/02/3-ways-to-increase-app-reliability-with-polly/>
<span class=button__icon>←</span>
<span class=button__text>3 Ways To Increase App Reliability With Polly</span>
</a>
</span>
<span class="button next">
<a href=https://im5tu.io/article/2022/01/extending-the-aws-sdk-for-.net/>
<span class=button__text>Extending the AWS SDK for .Net</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
<script src=https://utteranc.es/client.js repo=Im5tu/im5tu-hugo issue-term=url label=Comment theme=photon-dark crossorigin=anonymous async></script>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span>&copy; 2022</span>
<span><a href=https://im5tu.io/>Stuart Blackler</a></span>
<span> <a href=https://im5tu.io/article/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span>
</div>
</div>
<div class=footer__inner>
<div class=footer__content>
<span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span>
<p>This site uses Google Analytics for Analytics only</p>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
<script src=/js/site-20c12b24.js defer></script>
</body>
</html>
<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Stuart Blackler "><meta name="description" content="Learn how to publish a private helm repository using Github Pages Enterprise"><meta name="keywords" content=",k8s,helm,github"><meta name="robots" content="noodp"><meta name="theme-color" content><link rel="canonical" href="https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/"><title>Creating a private helm repository using Github Pages Enterprise :: CodeWithStu's Blog</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer"><link rel="stylesheet" href="https://im5tu.io/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css" integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k="><link rel="apple-touch-icon" sizes="180x180" href="https://im5tu.io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://im5tu.io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://im5tu.io/favicon-16x16.png"><link rel="manifest" href="https://im5tu.io/site.webmanifest"><link rel="mask-icon" href="https://im5tu.io/safari-pinned-tab.svg" color><link rel="shortcut icon" href="https://im5tu.io/favicon.ico"><meta name="msapplication-TileColor" content><meta itemprop="name" content="Creating a private helm repository using Github Pages Enterprise"><meta itemprop="description" content="Learn how to publish a private helm repository using Github Pages Enterprise"><meta itemprop="datePublished" content="2022-01-15T22:15:00+00:00"><meta itemprop="dateModified" content="2022-01-15T22:15:00+00:00"><meta itemprop="wordCount" content="984"><meta itemprop="keywords" content="k8s,helm,github,"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Creating a private helm repository using Github Pages Enterprise"><meta name="twitter:description" content="Learn how to publish a private helm repository using Github Pages Enterprise"><meta property="og:title" content="Creating a private helm repository using Github Pages Enterprise"><meta property="og:description" content="Learn how to publish a private helm repository using Github Pages Enterprise"><meta property="og:type" content="article"><meta property="og:url" content="https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/"><meta property="article:section" content="article"><meta property="article:published_time" content="2022-01-15T22:15:00+00:00"><meta property="article:modified_time" content="2022-01-15T22:15:00+00:00"><meta property="article:section" content="Development"><meta property="article:published_time" content="2022-01-15 22:15:00 +0000 UTC"><meta property="og:image" content="https://im5tu.io/img/profile.png"><meta property="og:site_name" content="CodeWithStu's Blog"><link rel="alternate" type="application/rss+xml" href="https://im5tu.io/article/index.xml" title="Stuart Blackler's Blog"><link rel="preconnect" href="https://api.github.com"><link rel="preconnect" href="https://partner.googleadservices.com"><link rel="preconnect" href="https://tpc.googlesyndication.com"><link rel="preconnect" href="https://www.googletagservices.com"><link rel="preconnect" href="https://googleads.g.doubleclick.net"><link rel="preconnect" href="https://pagead2.googlesyndication.com"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Bold.woff2"><link rel="preload" href="https://im5tu.io/fonts/Inter-UI-Regular.woff2"><style>body p{line-height:1.8em}main{padding:4em 0 0}a:hover{color:#004dc9}.post,.posts{max-width:1400px;padding:2em 0 0}.header__inner{width:100%;max-width:1400px}ul.menu__inner{padding-right:0}ul.menu__inner li:last-of-type{margin-right:0}.logo__cursor{background:#3b82f6}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2{margin-top:1.5em}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}#promotions img{margin:20px auto}#sponsorMessage{width:100%;background:#ffdf00;color:#242325;padding:10px;font-size:.9em}.flex-container{width:100%;display:inline-flex;justify-content:space-between}.flex-box{display:block}.hidden{display:hidden}.post-title{font-weight:700}.post-summary{font-style:italic;font-size:.8em;color:#222}.post-tags{font-size:.9em}.post-tags span.tag{margin:0 .5em;color:#111;text-decoration:underline}#introduction{margin:0 auto;text-align:center}#introduction p{display:block;text-align:center}#introduction p:first-child{font-weight:700;font-size:1.4em}#introduction p:nth-child(2){font-size:1.3em;font-style:italic}#introduction-container{width:80%;max-width:1400px;text-align:center}#introduction-whatido{margin-top:2em;background-color:#fafafa;width:100%;padding:3em 0}#introduction-whatido *{text-align:center}#introduction-whatido p{text-align:left}#introduction-whatido .flex-box{margin:0 2.5em;width:100%}#introduction-whatido .flex-box span.home-link{font-size:1.8em;margin-bottom:2em;color:#0665ff;font-weight:700;text-align:center}#introduction-whatido .flex-box span.home-link a,#introduction-whatido .flex-box span.home-link a:link{text-align:center;text-decoration:none}.footer{padding:0}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}.post-summary,.post-tags span.tag{color:#eaeaea}}@media(max-width:1450px){.post,.posts,main{padding:2em 4em}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QLMVXHCJ5K"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QLMVXHCJ5K")</script><script data-ad-client="ca-pub-8597760177900459" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div class="container"><header class="header"><span class="header__inner"><a href="https://im5tu.io/" style="text-decoration:none"><div class="logo"><span class="logo__mark">></span>
<span class="logo__text">im5tu.io</span>
<span class="logo__cursor"></span></div></a><span class="header__right"><nav class="menu"><ul class="menu__inner"><li><a href="https://im5tu.io/article/">Blog</a></li><li><a href="https://news.codewithstu.tv">Newsletter</a></li><li><a href="https://www.patreon.com/CodeWithStu">Patreon</a></li><li><a href="https://twitter.com/CodeWithStu">Twitter</a></li><li><a href="https://codewithstu.tv">YouTube</a></li></ul></nav><span class="menu-trigger"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class="content"><main class="post"><div style="font-style:italic;width:100%;background-color:#ffe12b;color:#333;text-align:center;padding:1px"><p>This page is available to sponsor. <a id="sponsorLink" href="https://im5tu.io/sponsorship/" ref="nofollow" target="_blank">Click Here</a> for more details!</p></div><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class="post-title"><a href="https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/">Creating a private helm repository using Github Pages Enterprise</a></h1><hr><aside id="toc"><div class="toc-title">Table of Contents</div><nav id="TableOfContents"><ul><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#setup-github-pages">Setup Github Pages</a></li><li><a href="#publish-action">Publish Action</a></li><li><a href="#using-with-helm">Using with Helm</a></li></ul></nav></aside><hr><div class="post-content"><p>In this article, we&rsquo;re going to take a look at how to create a private Helm repository with Github Pages. This guide requires you to have a Github Enterprise license as private Github Pages are only available to enterprise customers. I&rsquo;m showing this approach for the scenarios where setting up something like <a href="https://chartmuseum.com/">ChartMuseum</a> isn&rsquo;t possible or unwanted. Although this guide uses helm as the example, you can extend this to host anything under a privately authenticated Github page.</p><h2 id="prerequisites">Prerequisites</h2><p>For this approach to work, you need to have the following in place:</p><ol><li>A private Github repository as part of a <a href="https://github.com/enterprise">Github Enterprise</a></li><li>2 branches setup in the repository:<ul><li>main - This is where your chart source lives</li><li>gh-pages - This is where the charts are published</li></ul></li><li>A personal access token (PAT) that can access the repository</li></ol><h2 id="setup-github-pages">Setup Github Pages</h2><p>Once you have the prerequisites in place, you will need to setup your Github Pages with the following settings:</p><p><img src="https://im5tu.io/img/helm-private-github-pages/Pages-Setup.png" alt="Github Pages Setup"></p><p>The key parts of the setup are:</p><ol><li>Ensure that the repository pages are set to private</li><li>The branch is set to <code>gh-pages</code> at the root</li></ol><p>Please note that your URL that Github generates for you will be different and you do not actually need this URL for the rest of the tutorial.</p><h2 id="publish-action">Publish Action</h2><p>Helm relies on an index file that tells us the location of all the charts for a given repository and provides their download links. To build our index, we need to update it as soon as we push to the <code>main</code> branch. Let&rsquo;s take a look at the following Github Action:</p><pre><code class="language-yaml">name: Release Helm Charts

# Do not change this
concurrency: release-helm

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: 'src'
          fetch-depth: 0
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: 'dest'
          ref: 'gh-pages'
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v1

      - name: Package Helm Charts
        shell: bash
        run: |
          find src/charts/ -type f -name 'Chart.yaml' | sed -r 's|/[^/]+$||' | sort | uniq | xargs -L 1 helm dep up
          for d in src/charts/*/ ; do
              echo &quot;$d&quot;
              helm package &quot;$d&quot; -u -d dest
          done
      - name: Push New Files
        shell: bash
        working-directory: dest
        run: |
          helm repo index . --url https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/
          git config user.name &quot;Helm Updater&quot;
          git config user.email &quot;actions@users.noreply.github.com&quot;
          git add $(git ls-files -o --exclude-standard)
          git add index.yaml
          git commit -m &quot;Updated from ref: $GITHUB_SHA&quot;
          git push
</code></pre><p>Starting from the top, we have <code>concurrency: release-helm</code>. This tells Github that only a single instance of this action should be run as once, this is because later on we will be publishing the action to a different branch and git will get confused if we tried to do this in parallel. Next, we checkout two different branches, one for <code>main</code> and one for <code>gh-pages</code>:</p><pre><code class="language-yaml">- name: Checkout
  uses: actions/checkout@v2
  with:
    path: 'src'
    fetch-depth: 0
- name: Checkout
  uses: actions/checkout@v2
  with:
    path: 'dest'
    ref: 'gh-pages'
    fetch-depth: 0
</code></pre><p>This is so that we can easily use standard git commands to push files to a branch. The next interesting part is where we package the helm charts:</p><pre><code class="language-yaml">- name: Package Helm Charts
  shell: bash
  run: |
      find src/charts/ -type f -name 'Chart.yaml' | sed -r 's|/[^/]+$||' | sort | uniq | xargs -L 1 helm dep up
      for d in src/charts/*/ ; do
          echo &quot;$d&quot;
          helm package &quot;$d&quot; -u -d dest
      done
</code></pre><p>Here we look in the charts directory of <code>src</code>, which is where we cloned our <code>main</code> branch in to, and run <code>helm dep up</code> on each of the charts that we find, including subcharts. This ensures that we have everything that we need to package the chart.</p><p>When packaging the chart, we put it in the <code>dest</code> folder which is the folder we cloned our <code>gh-pages</code> branch to. This contains all of the charts from the <code>main</code> branch packaged alongside the helm index file.</p><p>In order to commit all of this back to git we use the following set of commands:</p><pre><code class="language-yaml">- name: Push New Files
  shell: bash
  working-directory: dest
  run: |
      helm repo index . --url https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/
      git config user.name &quot;Helm Updater&quot;
      git config user.email &quot;actions@users.noreply.github.com&quot;
      git add $(git ls-files -o --exclude-standard)
      git add index.yaml
      git commit -m &quot;Updated from ref: $GITHUB_SHA&quot;
      git push
</code></pre><p><code>helm repo index</code> creates the new index file, or updates it when it already exists, based on the contents of the <code>gh-pages</code> branch. Note the URL that&rsquo;s specified, which means that all content comes from here. Without this, helm will not work. It also <strong>must</strong> be a <code>raw.githubusercontent.com</code> address not the randomly generated URL from the pages settings. This is because this endpoint supports the basic authentication required for the private feed.</p><p><code>git add $(git ls-files -o --exclude-standard)</code> basically tells git to add any files that it thinks have been changed/added, before we run standard git commands to commit and push. To push, we do need to specify the name/email of the user that&rsquo;s committing, though this can be anything that you want.</p><p>Once the action has published, you should be able to access the generated helm index in your browser (you may need to authenticate with your normal github login or with your PAT token):</p><p><img src="https://im5tu.io/img/helm-private-github-pages/Uploaded-Index.png" alt="Generated helm index"></p><p>And you&rsquo;ll see this in your repository on the <code>gh-pages</code> branch:</p><p><img src="https://im5tu.io/img/helm-private-github-pages/Repository-Contents.png" alt="Generated Repository Contents"></p><h2 id="using-with-helm">Using with Helm</h2><p>To use the generated index with helm, you need to supply the <code>https://raw.githubusercontent.com</code> address we used earlier to helm, along with your username and generated PAT token:</p><pre><code class="language-bash">helm repo add private https://raw.githubusercontent.com/CodeWithStu/helm-private-demo/gh-pages/ --username &lt;Your Username&gt; --password &lt;Your PAT token&gt;
helm repo update
</code></pre><p>This will use Github basic authentication to pull the index and allow you to search and use the repository. The result will look something similar to the following:</p><pre><code class="language-bash">&gt; helm search repo private
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
private/generic-service 0.0.1           0.0.2           Generic Helm Chart
</code></pre><p>From here you are free to use your new helm repository as if it was any other helm repository. Enjoy!</p></div></article><hr><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class="tag"><a href="https://im5tu.io/tags/k8s/">k8s</a></span><span class="tag"><a href="https://im5tu.io/tags/helm/">helm</a></span><span class="tag"><a href="https://im5tu.io/tags/github/">github</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>984 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-01-15</p></div><hr><div id="promotions"><a href="https://geni.us/cws-springer" target="_blank"><img src="https://www.awltovhc.com/image-100677210-15518210" width="728" height="90" alt="Apress eBook Sale is here now! - Order selected eBooks for $12.99 each. (3rd-20th May)"></a>
<a href="https://geni.us/cws-namecheap" target="_blank"><img src="https://www.awltovhc.com/image-100677210-14326263" width="728" height="90" alt="Popular Domains for just 99 Cents at Namecheap!"></a>
<a href="https://geni.us/cws-mailchimp" target="_blank"><img src="https://www.ftjcfx.com/image-100677210-15488213" width="728" height="90" alt="See upto 88% more revenue with predictive segments!"></a></div></main></div><footer class="footer"><hr><div class="footer__inner"><div class="footer__content"><iframe src="https://codewithstu.substack.com/embed" width="480" height="320" frameborder="0" scrolling="no"></iframe></div></div><hr><div><div class="footer__inner"><div class="footer__content"><span>&copy; 2023</span>
<span><a href="https://im5tu.io/">Stuart Blackler</a></span>
<span><a href="https://im5tu.io/article/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div><p><a href="https://im5tu.io/tags">Tags</a> | <a href="https://im5tu.io/categories">Categories</a> | <a href="https://im5tu.io/sitemap.xml">Sitemap</a></p></div><div><p>This site uses Google Analytics for Analytics only, so may contain cookies.</p></div></div></footer></div><script type="text/javascript" src="https://im5tu.io/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js" integrity="sha512-IF1JGBDCj5WqlT+uiE4cJ6vhP9+T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script>
<script src="https://im5tu.io/js/site-376a1eef.js" defer></script></body></html>
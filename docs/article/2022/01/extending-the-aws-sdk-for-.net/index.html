<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="Stuart Blackler ">
<meta name=description content="In this article we're taking a look at how to extend the AWS SDK for .NET, which can be useful for various tasks like adding in some custom observability components into the request pipeline.">
<meta name=keywords content=",aspnetcore,dotnet,diagnostics,AWS">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://im5tu.io/article/2022/01/extending-the-aws-sdk-for-.net/>
<title>
Extending the AWS SDK for .Net :: Stuart Blackler's Blog
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/main.17863a81d979b637a02cd7632a4d86e9d80563ef460fd6af1a56962efcaa066b.css>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<meta name=msapplication-TileColor content>
<meta name=theme-color content>
<meta itemprop=name content="Extending the AWS SDK for .Net">
<meta itemprop=description content="In this article we're taking a look at how to extend the AWS SDK for .NET, which can be useful for various tasks like adding in some custom observability components into the request pipeline."><meta itemprop=datePublished content="2022-01-08T08:00:00+00:00">
<meta itemprop=dateModified content="2022-01-08T08:00:00+00:00">
<meta itemprop=wordCount content="813">
<meta itemprop=keywords content="aspnetcore,dotnet,diagnostics,AWS,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Extending the AWS SDK for .Net">
<meta name=twitter:description content="In this article we're taking a look at how to extend the AWS SDK for .NET, which can be useful for various tasks like adding in some custom observability components into the request pipeline.">
<meta property="og:title" content="Extending the AWS SDK for .Net">
<meta property="og:description" content="In this article we're taking a look at how to extend the AWS SDK for .NET, which can be useful for various tasks like adding in some custom observability components into the request pipeline.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://im5tu.io/article/2022/01/extending-the-aws-sdk-for-.net/"><meta property="article:section" content="article">
<meta property="article:published_time" content="2022-01-08T08:00:00+00:00">
<meta property="article:modified_time" content="2022-01-08T08:00:00+00:00">
<meta property="article:section" content="aspnetcore">
<meta property="article:section" content="dotnet">
<meta property="article:section" content="diagnostics">
<meta property="article:published_time" content="2022-01-08 08:00:00 +0000 UTC">
<link rel=alternate type=application/rss+xml href=https://im5tu.io/article/2022/01/extending-the-aws-sdk-for-.net/index.xml title="Stuart Blackler's Blog">
<meta property="og:image" content="https://im5tu.io/img/profile.jpg">
<meta property="og:site_name" content="Stuart Blackler's Blog">
<link rel=alternate type=application/rss+xml href=/index.xml title="Stuart Blackler's Blog">
<link rel=preconnect href=https://api.github.com>
<link rel=preconnect href=https://partner.googleadservices.com>
<link rel=preconnect href=https://tpc.googlesyndication.com>
<link rel=preconnect href=https://www.googletagservices.com>
<link rel=preconnect href=https://googleads.g.doubleclick.net>
<link rel=preconnect href=https://pagead2.googlesyndication.com>
<link rel=preload href=/fonts/Inter-UI-Bold.woff2>
<link rel=preload href=/fonts/Inter-UI-Regular.woff2>
<style>.post{max-width:1200px}.header__inner{width:100%;max-width:1160px}.toolbar{display:none!important}.copy-code-button{float:right;display:block;padding:8px 12px;font-size:.9em;background-color:#e2e2e2;border-left:1px solid #e2e2e2;border-bottom:1px solid #e2e2e2;border-radius:0;border-bottom-left-radius:10px;transition:all 250ms ease;margin:-18px;opacity:0}.copy-code-button:hover{cursor:pointer;opacity:.7;border-style:solid}.copy-code-button:focus{background-color:#e2e2e2;outline:0;border-style:solid}.copy-code-button:active{background-color:#e2e2e2;opacity:.5;border-style:solid}pre:hover .copy-code-button{opacity:1}.copy-code-button~pre{position:relative}table{width:100%;border-collapse:collapse}table th{background-color:#cecece;color:#222}table tr{margin:0;padding:0}table tr:first-child{border-left:1px solid #acacac;border-top:1px solid #acacac;border-right:1px solid #acacac}table tr td:first-child{border-left:1px solid #acacac}table tr td:last-child{border-right:1px solid #acacac}table td,table th{padding:.5em;border-bottom:1px solid #acacac;margin:0}h2 a:link,h2 a:visited,h3 a:link,h3 a:visited,h4 a:link,h4 a:visited,h5 a:link,h5 a:visited{text-decoration:none}h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover{text-decoration:underline}@media print{.copy-code-button{display:none}}@media(prefers-color-scheme:dark){.copy-code-button{background-color:#969696;color:#323232}}</style>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-88036425-1','auto'),ga('send','pageview')</script>
<script data-ad-client=ca-pub-8597760177900459 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>im5tu.io</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=/article/>Articles</a></li><li><a href=/article/index.xml>RSS Feed</a></li><li><a href=https://bit.ly/im5tu-tw>Twitter</a></li><li><a href=https://bit.ly/im5tu-yt>YouTube</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://im5tu.io/article/2022/01/extending-the-aws-sdk-for-.net/>Extending the AWS SDK for .Net</a>
</h1>
<hr>
<aside id=toc>
<div class=toc-title>Table of Contents</div>
<nav id=TableOfContents>
<ul>
<li><a href=#our-example>Our Example</a></li>
<li><a href=#customizing-the-request-pipeline>Customizing the request pipeline</a>
<ul>
<li><a href=#the-entrypoint-into-the-aws-sdk>The entrypoint into the AWS SDK</a></li>
<li><a href=#creating-an-instance-of-iruntimepipelinecustomizer>Creating an instance of IRuntimePipelineCustomizer</a></li>
<li><a href=#creating-our-ipipelinehandler>Creating our IPipelineHandler</a></li>
</ul>
</li>
<li><a href=#appendix>Appendix</a>
<ul>
<li><a href=#docker-compose-file>Docker Compose File</a></li>
<li><a href=#localstack-init-script>Localstack init script</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
<hr>
<div class=post-content>
<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden>
<iframe src=https://www.youtube.com/embed/oHXFG7G5bCo style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe>
</div>
<p>In this article we&rsquo;re taking a look at how to extend the AWS SDK for .NET, which can be useful for various tasks like adding in some custom observability components into the request pipeline. This article is a companion resource for the video linked above in case you prefer a written version. I&rsquo;m actively using the approach described here to implement distributed tracing with OpenTelemetry for all AWS calls at work.</p>
<h2 id=our-example>Our Example</h2>
<p>To demonstrate how to extend the AWS SDK, we are going to have a very simple application that simply lists all of the DynamoDB instances registered in the target system:</p>
<pre><code class=language-csharp>// NuGet Package Reference: &lt;PackageReference Include=&quot;AWSSDK.DynamoDBv2&quot; Version=&quot;3.7.2.4&quot; /&gt;

using Amazon.DynamoDBv2;
using Amazon.Runtime;
using Amazon.Runtime.Internal;

using var client = new AmazonDynamoDBClient(new AmazonDynamoDBConfig
{
    ServiceURL = &quot;http://localhost:4566&quot;
});

foreach (var table in (await client.ListTablesAsync()).TableNames)
    Console.WriteLine(&quot;Found: &quot; + table);

</code></pre>
<p>In order to run the above example, you need to have a working <a href=https://localstack.cloud/>localstack</a> instance running with one or more DynamoDB tables created. If you want to copy the files that I&rsquo;ve used, you can view them in the <a href=#appendix>appendix</a> below. If you&rsquo;re using my files, then you should see the following when you run the program:</p>
<p><img src=/img/extending-the-aws-sdk/initial-output.jpg alt="Output before customization"></p>
<h2 id=customizing-the-request-pipeline>Customizing the request pipeline</h2>
<p>There are three parts to getting our code injected into the AWS request pipeline:</p>
<ol>
<li>Telling the AWS SDK about our pipeline customizer</li>
<li>Creating a new instance of <code>IRuntimePipelineCustomizer</code></li>
<li>Creating a new instance of <code>IPipelineHandler</code></li>
</ol>
<p>Although the <code>IRuntimePipelineCustomizer</code> is in the internal namespace, this should be relatively stable to use as this is the same technique that AWS use themselves to extend the SDK. Just note, as an internal interface, you&rsquo;ll want to ensure that everything continues to work when upgrading.</p>
<h3 id=the-entrypoint-into-the-aws-sdk>The entrypoint into the AWS SDK</h3>
<p>The AWS SDK provides an extensibility point inside of the <code>Amazon.Runtime.Internal</code> namespace called <code>RuntimePipelineCustomizerRegistry</code>. I discovered this entrypoint by looking at the code for AWS X-Ray. This type is a singleton that allows you to register a class that customizes a pipeline. We are interested in a method called <code>Register</code> that takes an instance of <code>IRuntimePipelineCustomizer</code>:</p>
<pre><code class=language-csharp>RuntimePipelineCustomizerRegistry.Instance.Register(new AWSPipelineCustomization());

using var client = new AmazonDynamoDBClient(new AmazonDynamoDBConfig
{
    ServiceURL = &quot;http://localhost:4566&quot;
});

foreach (var table in (await client.ListTablesAsync()).TableNames)
    Console.WriteLine(&quot;Found: &quot; + table);
</code></pre>
<p>It&rsquo;s super important that you register your pipeline customization as early as possible so that you can capture all AWS SDK calls.</p>
<h3 id=creating-an-instance-of-iruntimepipelinecustomizer>Creating an instance of IRuntimePipelineCustomizer</h3>
<p>Once registered, an instance of <code>IRuntimePipelineCustomizer</code> will be called every time a new pipeline is created. The type that we need to implement is pretty trivial to implement as it&rsquo;s main purpose is to add one or more pipeline handlers:</p>
<pre><code class=language-csharp>internal sealed class AWSPipelineCustomization : IRuntimePipelineCustomizer
{
    public string UniqueName { get; } = nameof(AWSPipelineCustomization);

    public void Customize(Type type, RuntimePipeline pipeline)
    {
        if (!typeof(AmazonServiceClient).IsAssignableFrom(type))
            return;

        pipeline.AddHandlerAfter&lt;EndpointResolver&gt;(new AWSPipelineHandler());
    }
}
</code></pre>
<p>We first check to see whether the type that&rsquo;s passed in is assignable to an AmazonServiceClient so that we can safely ignore types that are invalid such as mock types.</p>
<p>To add our <code>IPipelineHandler</code> instance, we need to call one of three methods:</p>
<ol>
<li><code>AddHandler</code> - Adds to the end of the pipeline</li>
<li><code>AddHandlerBefore</code> - Adds before the specified handler type</li>
<li><code>AddHandlerAfter</code> - Adds after the specified handler type</li>
</ol>
<p>Generally speaking you want to add your handler after the <code>EndpointResolver</code> so that you catch all retry attempts and any credential based calls, such as IAM instance metadata.</p>
<h3 id=creating-our-ipipelinehandler>Creating our IPipelineHandler</h3>
<p>When are implementing the <code>IPipelineHandler</code>, we have two choices: implement the interface directly for maximum control or inherit from the class <code>PipelineHandler</code> <em>(recommended)</em> and override just the methods that we need. We&rsquo;re not going to do anything fancy in our implementation here, except record the AWS SDK call to the console window:</p>
<pre><code class=language-csharp>internal sealed class AWSPipelineHandler : PipelineHandler
{
    public override Task&lt;T&gt; InvokeAsync&lt;T&gt;(IExecutionContext executionContext)
    {
        Console.WriteLine(&quot;Executing: &quot; + executionContext.RequestContext.RequestName);
        return base.InvokeAsync&lt;T&gt;(executionContext);
    }

    public override void InvokeSync(IExecutionContext executionContext)
    {
        Console.WriteLine(&quot;Executing: &quot; + executionContext.RequestContext.RequestName);
        base.InvokeSync(executionContext);
    }
}
</code></pre>
<p>When you combine all of the code, you should receive an output similar to the following:</p>
<p><img src=/img/extending-the-aws-sdk/final-output.jpg alt="Output after customization"></p>
<p>The instance of <code>IExecutionContext</code> that you are passed contains both the request and (eventually) the response object, plus other useful information like the invocation id and whether the last exception is one that can be retried or not.</p>
<p>That&rsquo;s it for this article, I hope that you find this extension point useful for your own code base!</p>
<h2 id=appendix>Appendix</h2>
<p>You can also view the files on my <a href=https://github.com/Im5tu/videos/tree/main/TipsAndTricks/8%20-%20Extending%20the%20AWS%20SDK>Videos Github Repository</a>.</p>
<h3 id=docker-compose-file>Docker Compose File</h3>
<pre><code class=language-yaml>version: &quot;3.5&quot;
services:
  localstack:
    image: localstack/localstack:0.12.12
    restart: always
    ports:
      - &quot;4566:4566&quot;
    container_name: localstack
    environment:
      - HOSTNAME_EXTERNAL=localstack
      - SERVICES=dynamodb
      - DEFAULT_REGION=eu-north-1
      - AWS_ACCESS_KEY_ID=xxx
      - AWS_SECRET_ACCESS_KEY=xxx
      - AWS_DEFAULT_REGION=eu-north-1
    volumes:
      - ./scripts/init.sh:/docker-entrypoint-initaws.d/init.sh

</code></pre>
<h3 id=localstack-init-script>Localstack init script</h3>
<pre><code class=language-bash>#!/bin/sh
#Make sure this file is saved with LF line endings (not CRLF)
#Open this file in VSCode and look in the bottom right corner
set -x

aws dynamodb create-table \
    --table-name test \
    --attribute-definitions AttributeName=Key,AttributeType=S AttributeName=Code,AttributeType=S \
    --key-schema AttributeName=Key,KeyType=HASH AttributeName=Code,KeyType=RANGE \
    --provisioned-throughput ReadCapacityUnits=10,WriteCapacityUnits=5 \
    --endpoint-url http://localstack:4566

</code></pre>
</div>
</article>
<hr>
<div>
<p><i>If you haven't already, subscribe to my <a href=https://bit.ly/im5tu-yt target=_blank>YouTube Channel</a>, Code With Stu. Here you'll find different tip, tricks and tutorials using some of the latest technologies, in bitesize chunks.</i></p>
</div>
<hr>
<div class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://im5tu.io/tags/aspnetcore>aspnetcore</a></span><span class=tag><a href=https://im5tu.io/tags/dotnet>dotnet</a></span><span class=tag><a href=https://im5tu.io/tags/diagnostics>diagnostics</a></span><span class=tag><a href=https://im5tu.io/tags/aws>AWS</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>813 Words</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-01-08 08:00 +0000</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://im5tu.io/article/2022/01/creating-a-private-helm-repository-using-github-pages-enterprise/>
<span class=button__icon>←</span>
<span class=button__text>Creating a private helm repository using Github Pages Enterprise</span>
</a>
</span>
<span class="button next">
<a href=https://im5tu.io/article/2022/01/things-you-might-not-know-about-csharp-duck-typing/>
<span class=button__text>Things you might not know about CSharp - Duck Typing</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
<script src=https://utteranc.es/client.js repo=Im5tu/im5tu-hugo issue-term=url label=Comment theme=photon-dark crossorigin=anonymous async></script>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span>&copy; 2022</span>
<span><a href=https://im5tu.io/>Stuart Blackler</a></span>
<span> <a href=https://im5tu.io/article/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span>
</div>
</div>
<div class=footer__inner>
<div class=footer__content>
<span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
<script src=/js/site-20c12b24.js defer></script>
</body>
</html>